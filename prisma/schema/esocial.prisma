// ============================================================================
// eSocial — Módulo Completo
// Eventos, Lotes, Rubricas, Configuração
// ============================================================================

enum ESocialEnvironment {
  PRODUCTION
  RESTRICTED // Ambiente de testes
  @@map("ESocialEnvironment")
}

enum ESocialRubricType {
  EARNING     // Vencimento/provento
  DEDUCTION   // Desconto
  INFORMATIVE // Informativa (não afeta líquido)
  @@map("ESocialRubricType")
}

enum ESocialRubricIncidence {
  NORMAL
  EXEMPT
  SUSPENDED
  NOT_APPLICABLE
  @@map("ESocialRubricIncidence")
}

enum ESocialBatchStatus {
  OPEN
  VALIDATING
  VALIDATED
  SENDING
  SENT
  PROCESSING
  PROCESSED
  ERROR
  CLOSED
  @@map("ESocialBatchStatus")
}

enum ESocialEventType {
  // Tabelas (Grupo 1)
  S_1000  // Empregador
  S_1005  // Estabelecimentos
  S_1010  // Rubricas
  S_1020  // Lotações Tributárias
  S_1070  // Processos Administrativos/Judiciais
  // Não Periódicos (Grupo 2)
  S_2190  // Registro Preliminar
  S_2200  // Admissão
  S_2205  // Alteração de Dados Cadastrais
  S_2206  // Alteração Contratual
  S_2210  // CAT
  S_2220  // ASO
  S_2230  // Afastamento Temporário
  S_2231  // Cessão/Exercício em Outro Órgão
  S_2240  // Agentes Nocivos
  S_2298  // Reintegração
  S_2299  // Desligamento
  S_2300  // TSV - Início
  S_2306  // TSV - Alteração
  S_2399  // TSV - Término
  S_2400  // CDP - Início
  S_2405  // CDP - Alteração
  S_2410  // CDP - Término
  S_2416  // CDP
  S_2418  // CDP
  S_2420  // CDP
  // Periódicos (Grupo 3)
  S_1200  // Remuneração RPPS
  S_1202  // Remuneração Servidores
  S_1207  // Benefícios Previdenciários
  S_1210  // Pagamentos
  S_1260  // Comercialização Produção Rural
  S_1270  // Contratação Avulsos
  S_1280  // Informações Complementares
  S_1298  // Reabertura
  S_1299  // Fechamento
  // Exclusão
  S_3000  // Exclusão de Eventos
  S_3500  // Exclusão de Eventos Totalizadores
  // Totalizadores
  S_5001  // Bases de Cálculo
  S_5002  // IRRF
  S_5003  // FGTS
  S_5011  // Consolidação Bases
  S_5012  // Consolidação IRRF
  S_5013  // Consolidação FGTS
  @@map("ESocialEventType")
}

enum ESocialEventStatus {
  DRAFT
  VALIDATED
  QUEUED
  SENT
  ACCEPTED
  REJECTED
  CANCELLED
  EXCLUDED
  @@map("ESocialEventStatus")
}

model ESocialConfig {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String              @unique @map("company_id") @db.Uuid
  environment       ESocialEnvironment  @default(RESTRICTED)
  employerType      Int                 @default(1) @map("employer_type") // 1=Empresa, 2=Órgão Público, etc.
  softwareId        String?             @map("software_id") @db.VarChar(50)
  softwareName      String?             @map("software_name") @db.VarChar(100)
  certificatePath   String?             @map("certificate_path") @db.VarChar(500)
  certificateExpiry DateTime?           @map("certificate_expiry") @db.Date
  autoGenerate      Boolean             @default(false) @map("auto_generate")
  autoSend          Boolean             @default(false) @map("auto_send")
  isActive          Boolean             @default(true) @map("is_active")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at")
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("esocial_configs")
}

model ESocialRubric {
  id                  String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String                  @map("company_id") @db.Uuid
  code                String                  @db.VarChar(30)
  name                String                  @db.VarChar(200)
  type                ESocialRubricType
  incidenceINSS       ESocialRubricIncidence  @default(NORMAL) @map("incidence_inss")
  incidenceIRRF       ESocialRubricIncidence  @default(NORMAL) @map("incidence_irrf")
  incidenceFGTS       ESocialRubricIncidence  @default(NORMAL) @map("incidence_fgts")
  incidenceSindical   ESocialRubricIncidence  @default(NOT_APPLICABLE) @map("incidence_sindical")
  natureCode          String?                 @map("nature_code") @db.VarChar(10) // Código natureza da rubrica eSocial
  description         String?
  isActive            Boolean                 @default(true) @map("is_active")
  startDate           DateTime                @map("start_date") @db.Date
  endDate             DateTime?               @map("end_date") @db.Date
  createdAt           DateTime                @default(now()) @map("created_at")
  updatedAt           DateTime                @default(now()) @updatedAt @map("updated_at")
  company             Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
  @@map("esocial_rubrics")
}

model ESocialBatch {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid
  batchNumber     Int                 @map("batch_number")
  groupType       String              @map("group_type") @db.VarChar(20) // TABLES, NON_PERIODIC, PERIODIC
  status          ESocialBatchStatus  @default(OPEN)
  environment     ESocialEnvironment  @default(RESTRICTED)
  protocolNumber  String?             @map("protocol_number") @db.VarChar(50)
  receiptDate     DateTime?           @map("receipt_date")
  sentAt          DateTime?           @map("sent_at")
  processedAt     DateTime?           @map("processed_at")
  eventsCount     Int                 @default(0) @map("events_count")
  acceptedCount   Int                 @default(0) @map("accepted_count")
  rejectedCount   Int                 @default(0) @map("rejected_count")
  xmlContent      String?             @map("xml_content")
  responseXml     String?             @map("response_xml")
  errorMessage    String?             @map("error_message")
  sentBy          String?             @map("sent_by") @db.Uuid
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @default(now()) @updatedAt @map("updated_at")
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  events          ESocialEvent[]

  @@unique([companyId, batchNumber])
  @@index([companyId])
  @@index([companyId, groupType])
  @@map("esocial_batches")
}

model ESocialEvent {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String              @map("company_id") @db.Uuid
  eventType         ESocialEventType    @map("event_type")
  status            ESocialEventStatus  @default(DRAFT)
  sequenceNumber    Int                 @map("sequence_number")
  referenceYear     Int?                @map("reference_year")
  referenceMonth    Int?                @map("reference_month")
  employeeId        String?             @map("employee_id") @db.Uuid
  payrollId         String?             @map("payroll_id") @db.Uuid
  batchId           String?             @map("batch_id") @db.Uuid
  sourceEntityType  String?             @map("source_entity_type") @db.VarChar(50) // Employee, Payroll, Vacation, Termination, LeaveRecord
  sourceEntityId    String?             @map("source_entity_id") @db.Uuid
  eventId           String?             @map("event_id") @db.VarChar(50) // ID do evento no padrão eSocial (ID1234567890...)
  receiptNumber     String?             @map("receipt_number") @db.VarChar(50)
  receiptProtocol   String?             @map("receipt_protocol") @db.VarChar(100)
  xmlContent        String?             @map("xml_content")
  responseXml       String?             @map("response_xml")
  validationErrors  Json?               @map("validation_errors") // Array de erros de validação
  errorMessage      String?             @map("error_message")
  sentAt            DateTime?           @map("sent_at")
  processedAt       DateTime?           @map("processed_at")
  excludedByEventId String?             @map("excluded_by_event_id") @db.Uuid
  isRectification   Boolean             @default(false) @map("is_rectification")
  rectifiesEventId  String?             @map("rectifies_event_id") @db.Uuid
  createdBy         String?             @map("created_by") @db.Uuid
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at")
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee          Employee?           @relation("ESocialEventEmployee", fields: [employeeId], references: [id], onUpdate: NoAction)
  batch             ESocialBatch?       @relation(fields: [batchId], references: [id], onUpdate: NoAction)

  @@unique([companyId, sequenceNumber])
  @@index([companyId])
  @@index([companyId, referenceYear, referenceMonth])
  @@index([employeeId])
  @@index([batchId])
  @@index([sourceEntityType, sourceEntityId])
  @@map("esocial_events")
}
