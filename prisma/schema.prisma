// POC Delphi FRM - Schema do Banco de Dados
// Migração do sistema ERP industrial FRM (Delphi) para stack moderna

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum MaterialStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum MovementType {
  ENTRY        // Entrada
  EXIT         // Saída
  TRANSFER     // Transferência
  ADJUSTMENT   // Ajuste de inventário
  RETURN       // Devolução
  PRODUCTION   // Produção
}

enum InventoryType {
  RAW_MATERIAL    // Matéria-Prima
  SEMI_FINISHED   // Semi-Acabado
  FINISHED        // Pronto
  CRITICAL        // Crítico
  DEAD            // Morto
  SCRAP           // Refugo
}

enum QuoteStatus {
  DRAFT           // Rascunho
  PENDING         // Pendente
  SENT            // Enviado
  RECEIVED        // Recebido
  APPROVED        // Aprovado
  REJECTED        // Rejeitado
  CANCELLED       // Cancelado
}

enum PayableStatus {
  PENDING         // Pendente
  PARTIAL         // Parcialmente pago
  PAID            // Pago
  OVERDUE         // Vencido
  CANCELLED       // Cancelado
}

enum PayableType {
  INVOICE         // Nota Fiscal
  SERVICE         // Serviço
  TAX             // Imposto
  OTHER           // Outros
}

// =============================================================================
// TABELAS BASE (A00)
// =============================================================================

model Company {
  id          String   @id @default(uuid())
  code        Int      @unique // codEmpresa original
  name        String   // nomeEmpresa
  tradeName   String?  // nomeFantasia
  cnpj        String?  @unique
  ie          String?  // Inscrição Estadual
  address     String?
  city        String?
  state       String?
  zipCode     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  materials    Material[]
  suppliers    Supplier[]
  inventory    Inventory[]
  users        User[]
  categories   Category[]
  userCompanies UserCompany[]
  permissions  UserCompanyPermission[]
  cloneLogsSource CloneLog[] @relation("CloneSource")
  cloneLogsTarget CloneLog[] @relation("CloneTarget")
  purchaseOrders  PurchaseOrder[]
  receivedInvoices ReceivedInvoice[]
  userGroups   UserGroup[]
  systemSettings SystemSetting[]
  accountsPayable AccountsPayable[]
  materialRequisitions MaterialRequisition[]
  productionOrders ProductionOrder[]
  costCenters      CostCenter[]
  bankAccounts     BankAccount[]
  customers        Customer[]
  accountsReceivable AccountsReceivable[]
  approvalThresholds ApprovalThreshold[]

  @@map("companies")
}

model User {
  id          String   @id @default(uuid())
  code        Int?     // codUsuario original
  email       String   @unique
  name        String
  password    String?
  isActive    Boolean  @default(true)
  companyId   String?  // Empresa padrão (legado)
  company     Company? @relation(fields: [companyId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventoryMovements InventoryMovement[]
  userCompanies      UserCompany[]
  permissions        UserCompanyPermission[]
  cloneLogs          CloneLog[]
  auditLogs          AuditLog[]
  groupMemberships   UserGroupMember[]
  addedToGroups      UserGroupMember[] @relation("AddedByUser")
  settingsUpdated    SystemSetting[]
  payableApprovals   PayableApproval[]
  approverThresholds ApprovalThresholdApprover[]

  @@map("users")
}

// =============================================================================
// MULTI-TENANT: Permissões por Empresa
// =============================================================================

enum PermissionLevel {
  NONE
  VIEW
  EDIT
  FULL
}

enum SystemModule {
  MATERIALS
  SUPPLIERS
  QUOTES
  RECEIVING
  MATERIAL_OUT
  INVENTORY
  REPORTS
  SETTINGS
}

// Acesso do usuário às empresas do grupo
model UserCompany {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, companyId])
  @@map("user_companies")
}

// Permissões granulares: Usuário x Empresa x Módulo
model UserCompanyPermission {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  module      SystemModule
  permission  PermissionLevel @default(NONE)
  canShare    Boolean         @default(false)
  canClone    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([userId, companyId, module])
  @@map("user_company_permissions")
}

// =============================================================================
// CONFIGURAÇÕES DO SISTEMA
// =============================================================================

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @db.VarChar(100)
  value       Json
  category    String   @default("general") @db.VarChar(50)
  companyId   String?  @db.Uuid
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  description String?
  updatedBy   String?  @db.Uuid
  updatedByUser User?  @relation(fields: [updatedBy], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, companyId])
  @@index([category])
  @@map("system_settings")
}

// =============================================================================
// SISTEMA DE GRUPOS E PERMISSÕES
// =============================================================================

// Grupos de usuários com permissões
model UserGroup {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(100)
  description String?
  companyId   String?  @db.Uuid
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions Json     @default("[]") // Array de permissões: ["materials.*", "settings.landing.edit"]
  isSystem    Boolean  @default(false) // Grupos do sistema não podem ser deletados
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     UserGroupMember[]

  @@unique([name, companyId])
  @@map("user_groups")
}

// Membros dos grupos
model UserGroupMember {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String    @db.Uuid
  group     UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  addedBy   String?   @db.Uuid
  addedByUser User?   @relation("AddedByUser", fields: [addedBy], references: [id], onDelete: SetNull)
  addedAt   DateTime  @default(now())

  @@unique([userId, groupId])
  @@map("user_group_members")
}

// Log de clonagem de configurações entre empresas
model CloneLog {
  id              String   @id @default(uuid())
  sourceCompanyId String
  sourceCompany   Company  @relation("CloneSource", fields: [sourceCompanyId], references: [id])
  targetCompanyId String
  targetCompany   Company  @relation("CloneTarget", fields: [targetCompanyId], references: [id])
  entityType      String
  entityId        String
  clonedEntityId  String
  clonedBy        String
  clonedByUser    User     @relation(fields: [clonedBy], references: [id])
  createdAt       DateTime @default(now())

  @@map("clone_logs")
}

// =============================================================================
// MÓDULO CP06 - CATEGORIAS/FAMÍLIAS
// =============================================================================

model Category {
  id          String     @id @default(uuid())
  code        Int?       // codFamilia original
  name        String     // descFamilia
  parentId    String?    // id_pai para subcategorias
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  companyId   String?    // Empresa dona (null = global)
  company     Company?   @relation(fields: [companyId], references: [id])
  isShared    Boolean    @default(false) // Visível para outras empresas?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  materials   Material[]

  @@map("categories")
}

// =============================================================================
// MÓDULO CP10 - MATERIAIS
// =============================================================================

model Material {
  id                  String         @id @default(uuid())
  code                Int            @unique // codMaterial original
  internalCode        String?        // codigo interno (material_codCA)
  description         String         // descMaterial
  categoryId          String?
  category            Category?      @relation(fields: [categoryId], references: [id])
  unit                String         @default("UN") // unidadeEstoque
  location            String?        // local de armazenamento
  minQuantity         Float          @default(0) // qdeMinima
  maxQuantity         Float?         // qdeMaxima
  monthlyAverage      Float          @default(0) // qdeMediaMensal
  lastPurchasePrice   Float?         // vlrUnitUltCompra
  lastPurchaseDate    DateTime?      // dtUltCompra
  ncm                 String?        // código NCM
  status              MaterialStatus @default(ACTIVE)
  requiresQualityCheck Boolean       @default(false) // requerIQF
  isShared            Boolean        @default(false) // Visível para outras empresas?
  companyId           String?
  company             Company?       @relation(fields: [companyId], references: [id])
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  inventory           Inventory[]
  supplierMaterials   SupplierMaterial[]
  quoteItems          QuoteItem[]
  purchaseOrderItems  PurchaseOrderItem[]
  receivedInvoiceItems ReceivedInvoiceItem[]
  requisitionItems    MaterialRequisitionItem[]
  productionOrdersAsProduct ProductionOrder[] @relation("ProductionProduct")
  productionOrderMaterials ProductionOrderMaterial[] @relation("ProductionMaterial")

  @@map("materials")
}

// =============================================================================
// MÓDULO CP11 - FORNECEDORES
// =============================================================================

model Supplier {
  id              String         @id @default(uuid())
  code            Int            @unique // codFornecedor original
  companyName     String         // razaoSocial
  tradeName       String?        // nomeFantasia
  cnpj            String?        @unique
  cpf             String?        // para PF
  ie              String?        // Inscrição Estadual
  im              String?        // Inscrição Municipal
  address         String?
  number          String?
  complement      String?
  neighborhood    String?
  city            String?
  state           String?
  zipCode         String?
  country         String         @default("Brasil")
  phone           String?
  mobile          String?
  email           String?
  website         String?
  contactName     String?        // contato principal
  paymentTerms    String?        // condições de pagamento
  notes           String?
  status          SupplierStatus @default(ACTIVE)
  qualityIndex    Float?         // IQF - Índice de Qualidade
  isShared        Boolean        @default(false) // Visível para outras empresas?
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  supplierMaterials SupplierMaterial[]
  quotes            Quote[]
  inventoryMovements InventoryMovement[]
  purchaseOrders    PurchaseOrder[]
  receivedInvoices  ReceivedInvoice[]
  accountsPayable   AccountsPayable[]

  @@map("suppliers")
}

// Relação N:N entre Fornecedores e Materiais
model SupplierMaterial {
  id              String    @id @default(uuid())
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  supplierCode    String?   // código do material no fornecedor
  lastPrice       Float?
  lastPriceDate   DateTime?
  leadTimeDays    Int?      // prazo de entrega em dias
  minOrderQty     Float?    // quantidade mínima de pedido
  isPreferred     Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([supplierId, materialId])
  @@map("supplier_materials")
}

// =============================================================================
// MÓDULO EST10 - ESTOQUE
// =============================================================================

model Inventory {
  id              String        @id @default(uuid())
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])
  inventoryType   InventoryType @default(RAW_MATERIAL)
  quantity        Float         @default(0)
  reservedQty     Float         @default(0) // quantidade reservada
  availableQty    Float         @default(0) // quantidade disponível
  unitCost        Float         @default(0) // custo unitário médio
  totalCost       Float         @default(0) // custo total
  lastMovementAt  DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  movements       InventoryMovement[]

  @@unique([materialId, companyId, inventoryType])
  @@map("inventory")
}

model InventoryMovement {
  id              String       @id @default(uuid())
  inventoryId     String
  inventory       Inventory    @relation(fields: [inventoryId], references: [id])
  movementType    MovementType
  quantity        Float
  unitCost        Float        @default(0)
  totalCost       Float        @default(0)
  balanceAfter    Float        @default(0) // saldo após movimento
  documentType    String?      // tipo de documento (NF, OS, etc)
  documentNumber  String?      // número do documento
  documentId      String?      // referência ao documento
  supplierId      String?      // fornecedor (para entradas)
  supplier        Supplier?    @relation(fields: [supplierId], references: [id])
  notes           String?
  userId          String?
  user            User?        @relation(fields: [userId], references: [id])
  movementDate    DateTime     @default(now())
  createdAt       DateTime     @default(now())

  @@index([inventoryId, movementDate])
  @@map("inventory_movements")
}

// =============================================================================
// MÓDULO CP12 - ORÇAMENTOS/COTAÇÕES
// =============================================================================

model Quote {
  id              String      @id @default(uuid())
  code            Int         @unique // número do orçamento
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id])
  status          QuoteStatus @default(DRAFT)
  requestDate     DateTime    @default(now())
  responseDate    DateTime?
  validUntil      DateTime?
  paymentTerms    String?
  deliveryTerms   String?
  freightValue    Float       @default(0)
  discountPercent Float       @default(0)
  totalValue      Float       @default(0)
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           QuoteItem[]
  purchaseOrders  PurchaseOrder[]

  @@map("quotes")
}

model QuoteItem {
  id              String   @id @default(uuid())
  quoteId         String
  quote           Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material @relation(fields: [materialId], references: [id])
  quantity        Float
  unitPrice       Float    @default(0)
  totalPrice      Float    @default(0)
  deliveryDays    Int?     // prazo de entrega
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrderItems PurchaseOrderItem[]

  @@map("quote_items")
}

// =============================================================================
// MÓDULO PEDIDO DE COMPRA
// =============================================================================

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  APPROVED
  SENT
  PARTIAL
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id                    String              @id @default(uuid())
  code                  Int                 @unique
  supplierId            String
  supplier              Supplier            @relation(fields: [supplierId], references: [id])
  quoteId               String?
  quote                 Quote?              @relation(fields: [quoteId], references: [id])
  status                PurchaseOrderStatus @default(DRAFT)
  orderDate             DateTime            @default(now())
  expectedDeliveryDate  DateTime?
  actualDeliveryDate    DateTime?
  paymentTerms          String?
  deliveryTerms         String?
  freightValue          Float               @default(0)
  discountPercent       Float               @default(0)
  totalValue            Float               @default(0)
  notes                 String?
  companyId             String?
  company               Company?            @relation(fields: [companyId], references: [id])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  items                 PurchaseOrderItem[]
  receivedInvoices      ReceivedInvoice[]

  @@index([supplierId])
  @@index([companyId])
  @@index([status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  quoteItemId     String?
  quoteItem       QuoteItem?    @relation(fields: [quoteItemId], references: [id])
  quantity        Float
  unitPrice       Float         @default(0)
  totalPrice      Float         @default(0)
  receivedQty     Float         @default(0)
  deliveryDays    Int?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  receivedInvoiceItems ReceivedInvoiceItem[]

  @@index([purchaseOrderId])
  @@index([materialId])
  @@map("purchase_order_items")
}

// =============================================================================
// AUDITORIA (Governança)
// =============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id            String      @id @default(uuid()) @db.Uuid
  
  // Quem fez a ação
  userId        String?     @db.Uuid
  user          User?       @relation(fields: [userId], references: [id])
  userEmail     String?     // Backup caso user seja deletado
  userName      String?     // Backup caso user seja deletado
  
  // Contexto da empresa
  companyId     String?     @db.Uuid
  companyName   String?     // Backup caso company seja deletada
  
  // O que foi feito
  action        AuditAction
  entityType    String      // Ex: "Material", "Supplier", "Inventory"
  entityId      String?     // ID do registro afetado
  entityCode    String?     // Código legível (ex: código do material)
  
  // Detalhes da mudança
  description   String?     // Descrição legível da ação
  oldValues     Json?       // Valores anteriores (para UPDATE/DELETE)
  newValues     Json?       // Novos valores (para CREATE/UPDATE)
  changedFields String[]    @default([])
  
  // Metadados técnicos
  ipAddress     String?
  userAgent     String?
  requestPath   String?     // Rota da API chamada
  requestMethod String?     // GET, POST, PUT, DELETE
  
  // Timestamp
  createdAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// MÓDULO CP14 - ENTRADA DE NFe (EVOLUÍDO)
// =============================================================================

enum InvoiceStatus {
  PENDING     // Aguardando conferência
  VALIDATED   // Validado, aguardando aprovação
  APPROVED    // Aprovado, entrada realizada
  REJECTED    // Rejeitado
  CANCELLED   // Cancelado
}

enum MatchStatus {
  PENDING     // Aguardando vinculação
  MATCHED     // Vinculado com sucesso
  DIVERGENT   // Vinculado com divergência
  NOT_FOUND   // Material não encontrado
}

model ReceivedInvoice {
  id              String        @id @default(uuid())
  accessKey       String        @unique @db.VarChar(44)
  invoiceNumber   Int
  series          Int           @default(1)
  issueDate       DateTime
  
  // Fornecedor
  supplierId      String?
  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  supplierCnpj    String        @db.VarChar(18)
  supplierName    String        @db.VarChar(255)
  
  // Valores
  totalProducts   Float         @default(0)
  totalInvoice    Float         @default(0)
  freightValue    Float         @default(0)
  discountValue   Float         @default(0)
  
  // Impostos
  icmsBase        Float         @default(0)
  icmsValue       Float         @default(0)
  ipiValue        Float         @default(0)
  pisValue        Float         @default(0)
  cofinsValue     Float         @default(0)
  
  // Status
  status          InvoiceStatus @default(PENDING)
  
  // Relacionamentos
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  items           ReceivedInvoiceItem[]
  
  // Auditoria
  receivedAt      DateTime?
  receivedBy      String?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // Multi-tenant
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])
  
  // XML original
  xmlContent      String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Títulos a pagar gerados
  accountsPayable AccountsPayable[]
  
  @@index([status])
  @@index([companyId])
  @@index([supplierId])
  @@index([issueDate])
  @@map("received_invoices")
}

model ReceivedInvoiceItem {
  id                    String        @id @default(uuid())
  invoiceId             String
  invoice               ReceivedInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Dados do XML
  itemNumber            Int
  productCode           String        @db.VarChar(60)
  productName           String        @db.VarChar(255)
  ncm                   String?       @db.VarChar(10)
  cfop                  Int
  quantity              Float
  unit                  String        @db.VarChar(10)
  unitPrice             Float
  totalPrice            Float
  
  // Impostos do item
  icmsRate              Float         @default(0)
  icmsValue             Float         @default(0)
  ipiRate               Float         @default(0)
  ipiValue              Float         @default(0)
  
  // Vinculação
  materialId            String?
  material              Material?     @relation(fields: [materialId], references: [id])
  purchaseOrderItemId   String?
  purchaseOrderItem     PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id])
  
  // Conferência
  matchStatus           MatchStatus   @default(PENDING)
  divergenceType        String?       @db.VarChar(20)
  divergenceNote        String?
  
  // Recebimento
  receivedQty           Float         @default(0)
  
  createdAt             DateTime      @default(now())
  
  @@index([invoiceId])
  @@index([materialId])
  @@index([matchStatus])
  @@map("received_invoice_items")
}

// =============================================================================
// MÓDULO FN10 - CONTAS A PAGAR
// =============================================================================

model AccountsPayable {
  id              String         @id @default(uuid())
  code            Int            // número do título
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id])
  
  // Fornecedor
  supplierId      String
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  
  // Documento de origem
  documentType    PayableType    @default(INVOICE)
  documentNumber  String?        // número da NF
  documentId      String?        // ID da NFe (ReceivedInvoice)
  invoiceId       String?
  invoice         ReceivedInvoice? @relation(fields: [invoiceId], references: [id])
  
  // Valores
  description     String
  dueDate         DateTime       // data de vencimento
  issueDate       DateTime       @default(now()) // data de emissão
  originalValue   Float          // valor original
  discountValue   Float          @default(0) // desconto
  interestValue   Float          @default(0) // juros
  fineValue       Float          @default(0) // multa
  paidValue       Float          @default(0) // valor pago
  netValue        Float          // valor líquido a pagar
  
  // Status
  status          PayableStatus  @default(PENDING)
  paidAt          DateTime?      // data do pagamento
  
  // Parcela
  installmentNumber Int          @default(1) // número da parcela
  totalInstallments Int          @default(1) // total de parcelas
  
  // Categorização
  categoryId      String?        // natureza financeira
  costCenterId    String?        // centro de custo
  
  // Observações
  notes           String?
  barcode         String?        // código de barras do boleto
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Pagamentos
  payments        PayablePayment[]
  approvals       PayableApproval[]
  attachments     PayableAttachment[]
  costAllocations PayableCostAllocation[]
  bankTransactions BankTransaction[]
  
  @@unique([companyId, code])
  @@index([supplierId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceId])
  @@map("accounts_payable")
}

model PayablePayment {
  id                String          @id @default(uuid()) @db.Uuid
  payableId         String          @db.Uuid
  payable           AccountsPayable @relation(fields: [payableId], references: [id])
  
  paymentDate       DateTime        // data do pagamento
  value             Float           // valor pago
  discountValue     Float           @default(0) // desconto obtido
  interestValue     Float           @default(0) // juros pagos
  fineValue         Float           @default(0) // multa paga
  
  paymentMethod     String?         // forma de pagamento
  bankAccountId     String?         @db.Uuid
  bankAccount       BankAccount?    @relation("PaymentBankAccount", fields: [bankAccountId], references: [id])
  bankTransactionId String?         @db.Uuid
  bankTransaction   BankTransaction? @relation(fields: [bankTransactionId], references: [id])
  
  notes             String?
  
  createdBy         String?         @db.Uuid
  createdAt         DateTime        @default(now())
  
  @@index([payableId])
  @@index([paymentDate])
  @@map("payable_payments")
}

// =============================================================================
// MÓDULO CP15 - REQUISIÇÕES DE MATERIAL (SAÍDA)
// =============================================================================

enum RequisitionStatus {
  DRAFT           // Rascunho
  PENDING         // Aguardando aprovação
  APPROVED        // Aprovada
  IN_SEPARATION   // Em separação
  PARTIAL         // Parcialmente atendida
  COMPLETED       // Concluída
  CANCELLED       // Cancelada
}

enum RequisitionType {
  PRODUCTION      // Produção
  MAINTENANCE     // Manutenção
  ADMINISTRATIVE  // Administrativo
  PROJECT         // Projeto
  OTHER           // Outros
}

model MaterialRequisition {
  id              String             @id @default(uuid())
  code            Int                // número da requisição
  companyId       String?
  company         Company?           @relation(fields: [companyId], references: [id])
  
  // Tipo e destino
  type            RequisitionType    @default(PRODUCTION)
  costCenter      String?            // centro de custo
  projectCode     String?            // código do projeto
  orderNumber     String?            // número da OP/OS
  
  // Solicitante
  requestedBy     String?
  requestedAt     DateTime           @default(now())
  department      String?            // departamento solicitante
  
  // Aprovação
  status          RequisitionStatus  @default(DRAFT)
  approvedBy      String?
  approvedAt      DateTime?
  
  // Separação
  separatedBy     String?
  separatedAt     DateTime?
  
  // Observações
  notes           String?
  priority        Int                @default(3) // 1=Urgente, 2=Alta, 3=Normal, 4=Baixa
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Itens
  items           MaterialRequisitionItem[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([status])
  @@index([requestedAt])
  @@index([type])
  @@map("material_requisitions")
}

model MaterialRequisitionItem {
  id              String             @id @default(uuid())
  requisitionId   String
  requisition     MaterialRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  // Material
  materialId      String
  material        Material           @relation(fields: [materialId], references: [id])
  
  // Quantidades
  requestedQty    Float              // quantidade solicitada
  approvedQty     Float?             // quantidade aprovada
  separatedQty    Float              @default(0) // quantidade separada/entregue
  
  // Custo
  unitCost        Float              @default(0) // custo unitário no momento da saída
  totalCost       Float              @default(0) // custo total
  
  // Observações
  notes           String?
  
  createdAt       DateTime           @default(now())
  
  @@index([requisitionId])
  @@index([materialId])
  @@map("material_requisition_items")
}

// =============================================================================
// MÓDULO OP10 - ORDENS DE PRODUÇÃO
// =============================================================================

enum ProductionOrderStatus {
  PLANNED       // Planejada
  RELEASED      // Liberada
  IN_PROGRESS   // Em produção
  COMPLETED     // Concluída
  CANCELLED     // Cancelada
}

model ProductionOrder {
  id              String                @id @default(uuid())
  code            Int                   // número da OP
  companyId       String?
  company         Company?              @relation(fields: [companyId], references: [id])
  
  // Produto
  productId       String                // material a ser produzido
  product         Material              @relation("ProductionProduct", fields: [productId], references: [id])
  quantity        Float                 // quantidade a produzir
  producedQty     Float                 @default(0) // quantidade produzida
  
  // Datas
  plannedStart    DateTime?             // início planejado
  plannedEnd      DateTime?             // término planejado
  actualStart     DateTime?             // início real
  actualEnd       DateTime?             // término real
  dueDate         DateTime?             // data de entrega
  
  // Status e controle
  status          ProductionOrderStatus @default(PLANNED)
  priority        Int                   @default(3) // 1=Urgente, 2=Alta, 3=Normal, 4=Baixa
  
  // Referências
  salesOrderNumber String?              // pedido de venda
  customerName    String?               // cliente
  
  // Observações
  notes           String?
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Relações
  materials       ProductionOrderMaterial[]
  operations      ProductionOrderOperation[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([productId])
  @@map("production_orders")
}

model ProductionOrderMaterial {
  id              String            @id @default(uuid())
  orderId         String
  order           ProductionOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Material
  materialId      String
  material        Material          @relation("ProductionMaterial", fields: [materialId], references: [id])
  
  // Quantidades
  requiredQty     Float             // quantidade necessária
  consumedQty     Float             @default(0) // quantidade consumida
  
  // Custo
  unitCost        Float             @default(0)
  totalCost       Float             @default(0)
  
  notes           String?
  createdAt       DateTime          @default(now())
  
  @@index([orderId])
  @@index([materialId])
  @@map("production_order_materials")
}

model ProductionOrderOperation {
  id              String            @id @default(uuid())
  orderId         String
  order           ProductionOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Operação
  sequence        Int               // sequência da operação
  name            String            // nome da operação
  workCenter      String?           // centro de trabalho
  
  // Tempos planejados (minutos)
  setupTime       Float             @default(0) // tempo de setup
  runTime         Float             @default(0) // tempo de execução por unidade
  
  // Tempos reais
  actualSetupTime Float             @default(0)
  actualRunTime   Float             @default(0)
  
  // Quantidades
  plannedQty      Float             // quantidade planejada
  completedQty    Float             @default(0) // quantidade concluída
  scrapQty        Float             @default(0) // quantidade refugada
  
  // Status
  startedAt       DateTime?
  completedAt     DateTime?
  
  notes           String?
  createdAt       DateTime          @default(now())
  
  @@index([orderId])
  @@map("production_order_operations")
}

// =============================================================================
// MÓDULO FINANCEIRO EXPANDIDO
// =============================================================================

enum BankAccountType {
  CHECKING    // Conta Corrente
  SAVINGS     // Poupança
  INVESTMENT  // Investimento
  CASH        // Caixa
}

enum ReceivableStatus {
  PENDING     // Pendente
  PARTIAL     // Parcialmente pago
  PAID        // Pago
  OVERDUE     // Vencido
  CANCELLED   // Cancelado
  WRITTEN_OFF // Baixado como prejuízo
}

enum ReceivableType {
  INVOICE     // Nota Fiscal
  SERVICE     // Serviço
  CONTRACT    // Contrato
  OTHER       // Outros
}

enum ApprovalStatus {
  PENDING     // Aguardando
  APPROVED    // Aprovado
  REJECTED    // Rejeitado
  CANCELLED   // Cancelado
}

enum BankTransactionType {
  CREDIT        // Crédito
  DEBIT         // Débito
  TRANSFER_IN   // Transferência entrada
  TRANSFER_OUT  // Transferência saída
  FEE           // Taxa
  INTEREST      // Juros
  ADJUSTMENT    // Ajuste
}

// =============================================================================
// CENTRO DE CUSTO
// =============================================================================
model CostCenter {
  id          String    @id @default(uuid()) @db.Uuid
  code        String
  name        String
  description String?
  parentId    String?   @db.Uuid
  parent      CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children    CostCenter[] @relation("CostCenterHierarchy")
  companyId   String?   @db.Uuid
  company     Company?  @relation(fields: [companyId], references: [id])
  isActive    Boolean   @default(true)
  budget      Float?    @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  payableAllocations PayableCostAllocation[]
  receivables        AccountsReceivable[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([parentId])
  @@map("cost_centers")
}

// =============================================================================
// CONTAS BANCÁRIAS
// =============================================================================
model BankAccount {
  id              String          @id @default(uuid()) @db.Uuid
  code            String
  name            String
  bankCode        String?
  bankName        String?
  agency          String?
  agencyDigit     String?
  accountNumber   String?
  accountDigit    String?
  accountType     BankAccountType @default(CHECKING)
  companyId       String?         @db.Uuid
  company         Company?        @relation(fields: [companyId], references: [id])
  initialBalance  Float           @default(0)
  currentBalance  Float           @default(0)
  creditLimit     Float?          @default(0)
  isActive        Boolean         @default(true)
  isDefault       Boolean         @default(false)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  transactions        BankTransaction[]
  payablePayments     PayablePayment[]   @relation("PaymentBankAccount")
  receivablePayments  ReceivablePayment[]
  receivables         AccountsReceivable[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@map("bank_accounts")
}

// =============================================================================
// TRANSAÇÕES BANCÁRIAS
// =============================================================================
model BankTransaction {
  id                  String              @id @default(uuid()) @db.Uuid
  bankAccountId       String              @db.Uuid
  bankAccount         BankAccount         @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  transactionDate     DateTime
  type                BankTransactionType
  description         String
  value               Float
  balanceAfter        Float
  documentNumber      String?
  payableId           String?             @db.Uuid
  payable             AccountsPayable?    @relation(fields: [payableId], references: [id])
  receivableId        String?             @db.Uuid
  receivable          AccountsReceivable? @relation(fields: [receivableId], references: [id])
  transferToAccountId String?             @db.Uuid
  reconciled          Boolean             @default(false)
  reconciledAt        DateTime?
  reconciledBy        String?             @db.Uuid
  externalId          String?
  notes               String?
  createdBy           String?             @db.Uuid
  createdAt           DateTime            @default(now())
  
  payablePayments     PayablePayment[]
  receivablePayments  ReceivablePayment[]
  
  @@index([bankAccountId])
  @@index([transactionDate])
  @@index([payableId])
  @@index([receivableId])
  @@index([reconciled])
  @@map("bank_transactions")
}

// =============================================================================
// CLIENTES
// =============================================================================
model Customer {
  id                    String    @id @default(uuid()) @db.Uuid
  code                  String
  companyId             String?   @db.Uuid
  company               Company?  @relation(fields: [companyId], references: [id])
  type                  String    @default("COMPANY")
  companyName           String
  tradeName             String?
  cnpj                  String?
  cpf                   String?
  stateRegistration     String?
  municipalRegistration String?
  email                 String?
  phone                 String?
  mobile                String?
  website               String?
  contactName           String?
  addressStreet         String?
  addressNumber         String?
  addressComplement     String?
  addressNeighborhood   String?
  addressCity           String?
  addressState          String?
  addressZipCode        String?
  creditLimit           Float?    @default(0)
  paymentTermDays       Int?      @default(30)
  status                String    @default("ACTIVE")
  notes                 String?
  isShared              Boolean   @default(false)
  createdBy             String?   @db.Uuid
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  receivables AccountsReceivable[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([cnpj])
  @@index([status])
  @@map("customers")
}

// =============================================================================
// CONTAS A RECEBER
// =============================================================================
model AccountsReceivable {
  id                String           @id @default(uuid()) @db.Uuid
  code              Int
  companyId         String?          @db.Uuid
  company           Company?         @relation(fields: [companyId], references: [id])
  customerId        String           @db.Uuid
  customer          Customer         @relation(fields: [customerId], references: [id])
  documentType      ReceivableType   @default(INVOICE)
  documentNumber    String?
  documentId        String?          @db.Uuid
  description       String
  dueDate           DateTime
  issueDate         DateTime         @default(now())
  originalValue     Float
  discountValue     Float            @default(0)
  interestValue     Float            @default(0)
  fineValue         Float            @default(0)
  paidValue         Float            @default(0)
  netValue          Float
  status            ReceivableStatus @default(PENDING)
  paidAt            DateTime?
  installmentNumber Int              @default(1)
  totalInstallments Int              @default(1)
  categoryId        String?          @db.Uuid
  costCenterId      String?          @db.Uuid
  costCenter        CostCenter?      @relation(fields: [costCenterId], references: [id])
  bankAccountId     String?          @db.Uuid
  bankAccount       BankAccount?     @relation(fields: [bankAccountId], references: [id])
  boletoNumber      String?
  boletoBarcode     String?
  boletoUrl         String?
  pixCode           String?
  notes             String?
  createdBy         String?          @db.Uuid
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  payments          ReceivablePayment[]
  bankTransactions  BankTransaction[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_receivable")
}

// =============================================================================
// PAGAMENTOS DE CONTAS A RECEBER
// =============================================================================
model ReceivablePayment {
  id                String             @id @default(uuid()) @db.Uuid
  receivableId      String             @db.Uuid
  receivable        AccountsReceivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  paymentDate       DateTime
  value             Float
  discountValue     Float              @default(0)
  interestValue     Float              @default(0)
  fineValue         Float              @default(0)
  paymentMethod     String?
  bankAccountId     String?            @db.Uuid
  bankAccount       BankAccount?       @relation(fields: [bankAccountId], references: [id])
  bankTransactionId String?            @db.Uuid
  bankTransaction   BankTransaction?   @relation(fields: [bankTransactionId], references: [id])
  notes             String?
  createdBy         String?            @db.Uuid
  createdAt         DateTime           @default(now())
  
  @@index([receivableId])
  @@index([paymentDate])
  @@map("receivable_payments")
}

// =============================================================================
// APROVAÇÕES DE PAGAMENTO
// =============================================================================
model PayableApproval {
  id          String          @id @default(uuid()) @db.Uuid
  payableId   String          @db.Uuid
  payable     AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  approverId  String          @db.Uuid
  approver    User            @relation(fields: [approverId], references: [id])
  level       Int             @default(1)
  status      ApprovalStatus  @default(PENDING)
  approvedAt  DateTime?
  comments    String?
  createdAt   DateTime        @default(now())
  
  @@index([payableId])
  @@index([approverId])
  @@index([status])
  @@map("payable_approvals")
}

// =============================================================================
// ANEXOS DE CONTAS A PAGAR
// =============================================================================
model PayableAttachment {
  id          String          @id @default(uuid()) @db.Uuid
  payableId   String          @db.Uuid
  payable     AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  fileName    String
  fileType    String
  fileSize    Int
  fileUrl     String
  description String?
  uploadedBy  String?         @db.Uuid
  createdAt   DateTime        @default(now())
  
  @@index([payableId])
  @@map("payable_attachments")
}

// =============================================================================
// RATEIO DE CONTAS A PAGAR
// =============================================================================
model PayableCostAllocation {
  id           String          @id @default(uuid()) @db.Uuid
  payableId    String          @db.Uuid
  payable      AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  costCenterId String          @db.Uuid
  costCenter   CostCenter      @relation(fields: [costCenterId], references: [id])
  percentage   Float
  value        Float
  createdAt    DateTime        @default(now())
  
  @@index([payableId])
  @@index([costCenterId])
  @@map("payable_cost_allocations")
}

// =============================================================================
// ALÇADAS DE APROVAÇÃO
// =============================================================================
model ApprovalThreshold {
  id                String    @id @default(uuid()) @db.Uuid
  companyId         String?   @db.Uuid
  company           Company?  @relation(fields: [companyId], references: [id])
  name              String
  minValue          Float     @default(0)
  maxValue          Float?
  requiredApprovers Int       @default(1)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  approvers ApprovalThresholdApprover[]
  
  @@index([companyId])
  @@map("approval_thresholds")
}

// =============================================================================
// APROVADORES POR ALÇADA
// =============================================================================
model ApprovalThresholdApprover {
  id          String            @id @default(uuid()) @db.Uuid
  thresholdId String            @db.Uuid
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  userId      String            @db.Uuid
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  level       Int               @default(1)
  createdAt   DateTime          @default(now())
  
  @@index([thresholdId])
  @@index([userId])
  @@map("approval_threshold_approvers")
}
