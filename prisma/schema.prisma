// POC Delphi FRM - Schema do Banco de Dados
// Migração do sistema ERP industrial FRM (Delphi) para stack moderna

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum MaterialStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum MovementType {
  ENTRY        // Entrada
  EXIT         // Saída
  TRANSFER     // Transferência
  ADJUSTMENT   // Ajuste de inventário
  RETURN       // Devolução
  PRODUCTION   // Produção
}

enum InventoryType {
  RAW_MATERIAL    // Matéria-Prima
  SEMI_FINISHED   // Semi-Acabado
  FINISHED        // Pronto
  CRITICAL        // Crítico
  DEAD            // Morto
  SCRAP           // Refugo
}

enum QuoteStatus {
  DRAFT           // Rascunho
  PENDING         // Pendente
  SENT            // Enviado
  RECEIVED        // Recebido
  APPROVED        // Aprovado
  REJECTED        // Rejeitado
  CANCELLED       // Cancelado
}

enum PayableStatus {
  PENDING         // Pendente
  PARTIAL         // Parcialmente pago
  PAID            // Pago
  OVERDUE         // Vencido
  CANCELLED       // Cancelado
}

enum PayableType {
  INVOICE         // Nota Fiscal
  SERVICE         // Serviço
  TAX             // Imposto
  OTHER           // Outros
}

// =============================================================================
// TABELAS BASE (A00)
// =============================================================================

model Company {
  id          String   @id @default(uuid())
  code        Int      @unique // codEmpresa original
  name        String   // nomeEmpresa
  tradeName   String?  // nomeFantasia
  cnpj        String?  @unique
  ie          String?  // Inscrição Estadual
  address     String?
  city        String?
  state       String?
  zipCode     String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  materials    Material[]
  suppliers    Supplier[]
  inventory    Inventory[]
  users        User[]
  categories   Category[]
  userCompanies UserCompany[]
  permissions  UserCompanyPermission[]
  cloneLogsSource CloneLog[] @relation("CloneSource")
  cloneLogsTarget CloneLog[] @relation("CloneTarget")
  purchaseOrders  PurchaseOrder[]
  receivedInvoices ReceivedInvoice[]
  userGroups   UserGroup[]
  systemSettings SystemSetting[]
  accountsPayable AccountsPayable[]
  materialRequisitions MaterialRequisition[]
  productionOrders ProductionOrder[]
  costCenters      CostCenter[]
  bankAccounts     BankAccount[]
  customers        Customer[]
  accountsReceivable AccountsReceivable[]
  approvalThresholds ApprovalThreshold[]
  mrpRuns          MrpRun[]
  workCenters      WorkCenter[]
  oeeTargets       OeeTarget[]
  leads            Lead[]
  salesQuotes      SalesQuote[]
  salesOrders      SalesOrder[]
  stockLocations   StockLocation[]
  stockTransfers   StockTransfer[]
  physicalInventories PhysicalInventory[]
  departments      Department[]
  jobPositions     JobPosition[]
  employees        Employee[]
  payrolls         Payroll[]
  materialReceivings MaterialReceiving[]

  @@map("companies")
}

model User {
  id          String   @id @default(uuid())
  code        Int?     // codUsuario original
  email       String   @unique
  name        String
  password    String?
  isActive    Boolean  @default(true)
  companyId   String?  // Empresa padrão (legado)
  company     Company? @relation(fields: [companyId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventoryMovements InventoryMovement[]
  userCompanies      UserCompany[]
  permissions        UserCompanyPermission[]
  cloneLogs          CloneLog[]
  auditLogs          AuditLog[]
  groupMemberships   UserGroupMember[]
  addedToGroups      UserGroupMember[] @relation("AddedByUser")
  settingsUpdated    SystemSetting[]
  payableApprovals   PayableApproval[]
  approverThresholds ApprovalThresholdApprover[]
  assignedLeads      Lead[]
  transfersRequested         StockTransfer[] @relation("TransferRequested")
  transfersApproved          StockTransfer[] @relation("TransferApproved")
  transfersShipped           StockTransfer[] @relation("TransferShipped")
  transfersReceived          StockTransfer[] @relation("TransferReceived")
  requisitionApprovals       RequisitionApproval[]
  employeeProfile            Employee[]
  tutorials                  Tutorial[]

  @@map("users")
}

// =============================================================================
// MULTI-TENANT: Permissões por Empresa
// =============================================================================

enum PermissionLevel {
  NONE
  VIEW
  EDIT
  FULL
}

enum SystemModule {
  MATERIALS
  SUPPLIERS
  QUOTES
  RECEIVING
  MATERIAL_OUT
  INVENTORY
  REPORTS
  SETTINGS
}

// Acesso do usuário às empresas do grupo
model UserCompany {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, companyId])
  @@map("user_companies")
}

// Permissões granulares: Usuário x Empresa x Módulo
model UserCompanyPermission {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  module      SystemModule
  permission  PermissionLevel @default(NONE)
  canShare    Boolean         @default(false)
  canClone    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([userId, companyId, module])
  @@map("user_company_permissions")
}

// =============================================================================
// CONFIGURAÇÕES DO SISTEMA
// =============================================================================

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @db.VarChar(100)
  value       Json
  category    String   @default("general") @db.VarChar(50)
  companyId   String?  @db.Uuid
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  description String?
  updatedBy   String?  @db.Uuid
  updatedByUser User?  @relation(fields: [updatedBy], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, companyId])
  @@index([category])
  @@map("system_settings")
}

// =============================================================================
// SISTEMA DE GRUPOS E PERMISSÕES
// =============================================================================

// Grupos de usuários com permissões
model UserGroup {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(100)
  description String?
  companyId   String?  @db.Uuid
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  permissions Json     @default("[]") // Array de permissões: ["materials.*", "settings.landing.edit"]
  isSystem    Boolean  @default(false) // Grupos do sistema não podem ser deletados
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     UserGroupMember[]

  @@unique([name, companyId])
  @@map("user_groups")
}

// Membros dos grupos
model UserGroupMember {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String    @db.Uuid
  group     UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  addedBy   String?   @db.Uuid
  addedByUser User?   @relation("AddedByUser", fields: [addedBy], references: [id], onDelete: SetNull)
  addedAt   DateTime  @default(now())

  @@unique([userId, groupId])
  @@map("user_group_members")
}

// Log de clonagem de configurações entre empresas
model CloneLog {
  id              String   @id @default(uuid())
  sourceCompanyId String
  sourceCompany   Company  @relation("CloneSource", fields: [sourceCompanyId], references: [id])
  targetCompanyId String
  targetCompany   Company  @relation("CloneTarget", fields: [targetCompanyId], references: [id])
  entityType      String
  entityId        String
  clonedEntityId  String
  clonedBy        String
  clonedByUser    User     @relation(fields: [clonedBy], references: [id])
  createdAt       DateTime @default(now())

  @@map("clone_logs")
}

// =============================================================================
// MÓDULO CP06 - CATEGORIAS/FAMÍLIAS
// =============================================================================

model Category {
  id          String     @id @default(uuid())
  code        Int?       // codFamilia original
  name        String     // descFamilia
  parentId    String?    // id_pai para subcategorias
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  companyId   String?    // Empresa dona (null = global)
  company     Company?   @relation(fields: [companyId], references: [id])
  isShared    Boolean    @default(false) // Visível para outras empresas?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  materials   Material[]

  @@map("categories")
}

// =============================================================================
// MÓDULO CP10 - MATERIAIS
// =============================================================================

model Material {
  id                  String         @id @default(uuid())
  code                Int            @unique // codMaterial original
  internalCode        String?        // codigo interno (material_codCA)
  description         String         // descMaterial
  categoryId          String?
  category            Category?      @relation(fields: [categoryId], references: [id])
  unit                String         @default("UN") // unidadeEstoque
  location            String?        // local de armazenamento
  minQuantity         Float          @default(0) // qdeMinima
  maxQuantity         Float?         // qdeMaxima
  monthlyAverage      Float          @default(0) // qdeMediaMensal
  lastPurchasePrice   Float?         // vlrUnitUltCompra
  lastPurchaseDate    DateTime?      // dtUltCompra
  ncm                 String?        // código NCM
  status              MaterialStatus @default(ACTIVE)
  requiresQualityCheck Boolean       @default(false) // requerIQF
  isShared            Boolean        @default(false) // Visível para outras empresas?
  companyId           String?
  company             Company?       @relation(fields: [companyId], references: [id])
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  inventory           Inventory[]
  supplierMaterials   SupplierMaterial[]
  quoteItems          QuoteItem[]
  purchaseOrderItems  PurchaseOrderItem[]
  receivedInvoiceItems ReceivedInvoiceItem[]
  requisitionItems    MaterialRequisitionItem[]
  productionOrdersAsProduct ProductionOrder[] @relation("ProductionProduct")
  productionOrderMaterials ProductionOrderMaterial[] @relation("ProductionMaterial")
  bomAsParent         BomItem[]       @relation("BomParent")
  bomAsChild          BomItem[]       @relation("BomChild")
  mrpParameter        MrpParameter?
  mrpSuggestions      MrpSuggestion[]
  salesQuoteItems     SalesQuoteItem[]
  salesOrderItems     SalesOrderItem[]
  locationInventory   LocationInventory[]
  stockTransferItems  StockTransferItem[]
  inventoryCounts     InventoryCount[]
  receivingItems      MaterialReceivingItem[]

  @@map("materials")
}

// =============================================================================
// MÓDULO CP11 - FORNECEDORES
// =============================================================================

model Supplier {
  id              String         @id @default(uuid())
  code            Int            @unique // codFornecedor original
  companyName     String         // razaoSocial
  tradeName       String?        // nomeFantasia
  cnpj            String?        @unique
  cpf             String?        // para PF
  ie              String?        // Inscrição Estadual
  im              String?        // Inscrição Municipal
  address         String?
  number          String?
  complement      String?
  neighborhood    String?
  city            String?
  state           String?
  zipCode         String?
  country         String         @default("Brasil")
  phone           String?
  mobile          String?
  email           String?
  website         String?
  contactName     String?        // contato principal
  paymentTerms    String?        // condições de pagamento
  notes           String?
  status          SupplierStatus @default(ACTIVE)
  qualityIndex    Float?         // IQF - Índice de Qualidade
  isShared        Boolean        @default(false) // Visível para outras empresas?
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  supplierMaterials SupplierMaterial[]
  quotes            Quote[]
  inventoryMovements InventoryMovement[]
  purchaseOrders    PurchaseOrder[]
  receivedInvoices  ReceivedInvoice[]
  accountsPayable   AccountsPayable[]
  materialReceivings MaterialReceiving[]

  @@map("suppliers")
}

// Relação N:N entre Fornecedores e Materiais
model SupplierMaterial {
  id              String    @id @default(uuid())
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  supplierCode    String?   // código do material no fornecedor
  lastPrice       Float?
  lastPriceDate   DateTime?
  leadTimeDays    Int?      // prazo de entrega em dias
  minOrderQty     Float?    // quantidade mínima de pedido
  isPreferred     Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([supplierId, materialId])
  @@map("supplier_materials")
}

// =============================================================================
// MÓDULO EST10 - ESTOQUE
// =============================================================================

model Inventory {
  id              String        @id @default(uuid())
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])
  inventoryType   InventoryType @default(RAW_MATERIAL)
  quantity        Float         @default(0)
  reservedQty     Float         @default(0) // quantidade reservada
  availableQty    Float         @default(0) // quantidade disponível
  unitCost        Float         @default(0) // custo unitário médio
  totalCost       Float         @default(0) // custo total
  lastMovementAt  DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  movements       InventoryMovement[]

  @@unique([materialId, companyId, inventoryType])
  @@map("inventory")
}

model InventoryMovement {
  id              String       @id @default(uuid())
  inventoryId     String
  inventory       Inventory    @relation(fields: [inventoryId], references: [id])
  movementType    MovementType
  quantity        Float
  unitCost        Float        @default(0)
  totalCost       Float        @default(0)
  balanceAfter    Float        @default(0) // saldo após movimento
  documentType    String?      // tipo de documento (NF, OS, etc)
  documentNumber  String?      // número do documento
  documentId      String?      // referência ao documento
  supplierId      String?      // fornecedor (para entradas)
  supplier        Supplier?    @relation(fields: [supplierId], references: [id])
  notes           String?
  userId          String?
  user            User?        @relation(fields: [userId], references: [id])
  movementDate    DateTime     @default(now())
  createdAt       DateTime     @default(now())

  @@index([inventoryId, movementDate])
  @@map("inventory_movements")
}

// =============================================================================
// MÓDULO CP12 - ORÇAMENTOS/COTAÇÕES
// =============================================================================

model Quote {
  id              String      @id @default(uuid())
  code            Int         @unique // número do orçamento
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id])
  status          QuoteStatus @default(DRAFT)
  requestDate     DateTime    @default(now())
  responseDate    DateTime?
  validUntil      DateTime?
  paymentTerms    String?
  deliveryTerms   String?
  freightValue    Float       @default(0)
  discountPercent Float       @default(0)
  totalValue      Float       @default(0)
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           QuoteItem[]
  purchaseOrders  PurchaseOrder[]

  @@map("quotes")
}

model QuoteItem {
  id              String   @id @default(uuid())
  quoteId         String
  quote           Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material @relation(fields: [materialId], references: [id])
  quantity        Float
  unitPrice       Float    @default(0)
  totalPrice      Float    @default(0)
  deliveryDays    Int?     // prazo de entrega
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrderItems PurchaseOrderItem[]

  @@map("quote_items")
}

// =============================================================================
// MÓDULO PEDIDO DE COMPRA
// =============================================================================

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  APPROVED
  SENT
  PARTIAL
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id                    String              @id @default(uuid())
  code                  Int                 @unique
  supplierId            String
  supplier              Supplier            @relation(fields: [supplierId], references: [id])
  quoteId               String?
  quote                 Quote?              @relation(fields: [quoteId], references: [id])
  status                PurchaseOrderStatus @default(DRAFT)
  orderDate             DateTime            @default(now())
  expectedDeliveryDate  DateTime?
  actualDeliveryDate    DateTime?
  paymentTerms          String?
  deliveryTerms         String?
  freightValue          Float               @default(0)
  discountPercent       Float               @default(0)
  totalValue            Float               @default(0)
  notes                 String?
  companyId             String?
  company               Company?            @relation(fields: [companyId], references: [id])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  items                 PurchaseOrderItem[]
  receivedInvoices      ReceivedInvoice[]
  materialReceivings    MaterialReceiving[]

  @@index([supplierId])
  @@index([companyId])
  @@index([status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  materialId      String
  material        Material      @relation(fields: [materialId], references: [id])
  quoteItemId     String?
  quoteItem       QuoteItem?    @relation(fields: [quoteItemId], references: [id])
  quantity        Float
  unitPrice       Float         @default(0)
  totalPrice      Float         @default(0)
  receivedQty     Float         @default(0)
  deliveryDays    Int?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  receivedInvoiceItems ReceivedInvoiceItem[]
  materialReceivingItems MaterialReceivingItem[]

  @@index([purchaseOrderId])
  @@index([materialId])
  @@map("purchase_order_items")
}

// =============================================================================
// AUDITORIA (Governança)
// =============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id            String      @id @default(uuid()) @db.Uuid
  
  // Quem fez a ação
  userId        String?     @db.Uuid
  user          User?       @relation(fields: [userId], references: [id])
  userEmail     String?     // Backup caso user seja deletado
  userName      String?     // Backup caso user seja deletado
  
  // Contexto da empresa
  companyId     String?     @db.Uuid
  companyName   String?     // Backup caso company seja deletada
  
  // O que foi feito
  action        AuditAction
  entityType    String      // Ex: "Material", "Supplier", "Inventory"
  entityId      String?     // ID do registro afetado
  entityCode    String?     // Código legível (ex: código do material)
  
  // Detalhes da mudança
  description   String?     // Descrição legível da ação
  oldValues     Json?       // Valores anteriores (para UPDATE/DELETE)
  newValues     Json?       // Novos valores (para CREATE/UPDATE)
  changedFields String[]    @default([])
  
  // Metadados técnicos
  ipAddress     String?
  userAgent     String?
  requestPath   String?     // Rota da API chamada
  requestMethod String?     // GET, POST, PUT, DELETE
  
  // Timestamp
  createdAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([companyId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// MÓDULO CP14 - ENTRADA DE NFe (EVOLUÍDO)
// =============================================================================

enum InvoiceStatus {
  PENDING     // Aguardando conferência
  VALIDATED   // Validado, aguardando aprovação
  APPROVED    // Aprovado, entrada realizada
  REJECTED    // Rejeitado
  CANCELLED   // Cancelado
}

enum MatchStatus {
  PENDING     // Aguardando vinculação
  MATCHED     // Vinculado com sucesso
  DIVERGENT   // Vinculado com divergência
  NOT_FOUND   // Material não encontrado
}

model ReceivedInvoice {
  id              String        @id @default(uuid())
  accessKey       String        @unique @db.VarChar(44)
  invoiceNumber   Int
  series          Int           @default(1)
  issueDate       DateTime
  
  // Fornecedor
  supplierId      String?
  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  supplierCnpj    String        @db.VarChar(18)
  supplierName    String        @db.VarChar(255)
  
  // Valores
  totalProducts   Float         @default(0)
  totalInvoice    Float         @default(0)
  freightValue    Float         @default(0)
  discountValue   Float         @default(0)
  
  // Impostos
  icmsBase        Float         @default(0)
  icmsValue       Float         @default(0)
  ipiValue        Float         @default(0)
  pisValue        Float         @default(0)
  cofinsValue     Float         @default(0)
  
  // Status
  status          InvoiceStatus @default(PENDING)
  
  // Relacionamentos
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  items           ReceivedInvoiceItem[]
  
  // Auditoria
  receivedAt      DateTime?
  receivedBy      String?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // Multi-tenant
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])
  
  // XML original
  xmlContent      String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Títulos a pagar gerados
  accountsPayable AccountsPayable[]
  materialReceivings MaterialReceiving[]
  
  @@index([status])
  @@index([companyId])
  @@index([supplierId])
  @@index([issueDate])
  @@map("received_invoices")
}

model ReceivedInvoiceItem {
  id                    String        @id @default(uuid())
  invoiceId             String
  invoice               ReceivedInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Dados do XML
  itemNumber            Int
  productCode           String        @db.VarChar(60)
  productName           String        @db.VarChar(255)
  ncm                   String?       @db.VarChar(10)
  cfop                  Int
  quantity              Float
  unit                  String        @db.VarChar(10)
  unitPrice             Float
  totalPrice            Float
  
  // Impostos do item
  icmsRate              Float         @default(0)
  icmsValue             Float         @default(0)
  ipiRate               Float         @default(0)
  ipiValue              Float         @default(0)
  
  // Vinculação
  materialId            String?
  material              Material?     @relation(fields: [materialId], references: [id])
  purchaseOrderItemId   String?
  purchaseOrderItem     PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id])
  
  // Conferência
  matchStatus           MatchStatus   @default(PENDING)
  divergenceType        String?       @db.VarChar(20)
  divergenceNote        String?
  
  // Recebimento
  receivedQty           Float         @default(0)
  
  createdAt             DateTime      @default(now())
  
  @@index([invoiceId])
  @@index([materialId])
  @@index([matchStatus])
  @@map("received_invoice_items")
}

// =============================================================================
// MÓDULO FN10 - CONTAS A PAGAR
// =============================================================================

model AccountsPayable {
  id              String         @id @default(uuid())
  code            Int            // número do título
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id])
  
  // Fornecedor
  supplierId      String
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  
  // Documento de origem
  documentType    PayableType    @default(INVOICE)
  documentNumber  String?        // número da NF
  documentId      String?        // ID da NFe (ReceivedInvoice)
  invoiceId       String?
  invoice         ReceivedInvoice? @relation(fields: [invoiceId], references: [id])
  
  // Valores
  description     String
  dueDate         DateTime       // data de vencimento
  issueDate       DateTime       @default(now()) // data de emissão
  originalValue   Float          // valor original
  discountValue   Float          @default(0) // desconto
  interestValue   Float          @default(0) // juros
  fineValue       Float          @default(0) // multa
  paidValue       Float          @default(0) // valor pago
  netValue        Float          // valor líquido a pagar
  
  // Status
  status          PayableStatus  @default(PENDING)
  paidAt          DateTime?      // data do pagamento
  
  // Parcela
  installmentNumber Int          @default(1) // número da parcela
  totalInstallments Int          @default(1) // total de parcelas
  
  // Categorização
  categoryId      String?        // natureza financeira
  costCenterId    String?        // centro de custo
  
  // Observações
  notes           String?
  barcode         String?        // código de barras do boleto
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Pagamentos
  payments        PayablePayment[]
  approvals       PayableApproval[]
  attachments     PayableAttachment[]
  costAllocations PayableCostAllocation[]
  bankTransactions BankTransaction[]
  
  @@unique([companyId, code])
  @@index([supplierId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceId])
  @@map("accounts_payable")
}

model PayablePayment {
  id                String          @id @default(uuid()) @db.Uuid
  payableId         String          @db.Uuid
  payable           AccountsPayable @relation(fields: [payableId], references: [id])
  
  paymentDate       DateTime        // data do pagamento
  value             Float           // valor pago
  discountValue     Float           @default(0) // desconto obtido
  interestValue     Float           @default(0) // juros pagos
  fineValue         Float           @default(0) // multa paga
  
  paymentMethod     String?         // forma de pagamento
  bankAccountId     String?         @db.Uuid
  bankAccount       BankAccount?    @relation("PaymentBankAccount", fields: [bankAccountId], references: [id])
  bankTransactionId String?         @db.Uuid
  bankTransaction   BankTransaction? @relation(fields: [bankTransactionId], references: [id])
  
  notes             String?
  
  createdBy         String?         @db.Uuid
  createdAt         DateTime        @default(now())
  
  @@index([payableId])
  @@index([paymentDate])
  @@map("payable_payments")
}

// =============================================================================
// MÓDULO CP15 - REQUISIÇÕES DE MATERIAL (SAÍDA)
// =============================================================================

enum RequisitionStatus {
  DRAFT           // Rascunho
  PENDING         // Aguardando aprovação
  APPROVED        // Aprovada
  IN_SEPARATION   // Em separação
  PARTIAL         // Parcialmente atendida
  COMPLETED       // Concluída
  CANCELLED       // Cancelada
}

enum RequisitionType {
  PRODUCTION      // Produção
  MAINTENANCE     // Manutenção
  ADMINISTRATIVE  // Administrativo
  PROJECT         // Projeto
  OTHER           // Outros
}

model MaterialRequisition {
  id              String             @id @default(uuid())
  code            Int                // número da requisição
  companyId       String?
  company         Company?           @relation(fields: [companyId], references: [id])
  
  // Tipo e destino
  type            RequisitionType    @default(PRODUCTION)
  costCenter      String?            // centro de custo
  projectCode     String?            // código do projeto
  orderNumber     String?            // número da OP/OS
  
  // Solicitante
  requestedBy     String?
  requestedAt     DateTime           @default(now())
  department      String?            // departamento solicitante
  
  // Aprovação
  status          RequisitionStatus  @default(DRAFT)
  approvedBy      String?
  approvedAt      DateTime?
  
  // Separação
  separatedBy     String?
  separatedAt     DateTime?
  
  // Observações
  notes           String?
  priority        Int                @default(3) // 1=Urgente, 2=Alta, 3=Normal, 4=Baixa
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Itens
  items           MaterialRequisitionItem[]
  approvals       RequisitionApproval[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([status])
  @@index([requestedAt])
  @@index([type])
  @@map("material_requisitions")
}

model MaterialRequisitionItem {
  id              String             @id @default(uuid())
  requisitionId   String
  requisition     MaterialRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  // Material
  materialId      String
  material        Material           @relation(fields: [materialId], references: [id])
  
  // Quantidades
  requestedQty    Float              // quantidade solicitada
  approvedQty     Float?             // quantidade aprovada
  separatedQty    Float              @default(0) // quantidade separada/entregue
  
  // Custo
  unitCost        Float              @default(0) // custo unitário no momento da saída
  totalCost       Float              @default(0) // custo total
  
  // Observações
  notes           String?
  
  createdAt       DateTime           @default(now())
  
  @@index([requisitionId])
  @@index([materialId])
  @@map("material_requisition_items")
}

// =============================================================================
// MÓDULO OP10 - ORDENS DE PRODUÇÃO
// =============================================================================

enum ProductionOrderStatus {
  PLANNED       // Planejada
  RELEASED      // Liberada
  IN_PROGRESS   // Em produção
  COMPLETED     // Concluída
  CANCELLED     // Cancelada
}

model ProductionOrder {
  id              String                @id @default(uuid())
  code            Int                   // número da OP
  companyId       String?
  company         Company?              @relation(fields: [companyId], references: [id])
  
  // Produto
  productId       String                // material a ser produzido
  product         Material              @relation("ProductionProduct", fields: [productId], references: [id])
  quantity        Float                 // quantidade a produzir
  producedQty     Float                 @default(0) // quantidade produzida
  
  // Datas
  plannedStart    DateTime?             // início planejado
  plannedEnd      DateTime?             // término planejado
  actualStart     DateTime?             // início real
  actualEnd       DateTime?             // término real
  dueDate         DateTime?             // data de entrega
  
  // Status e controle
  status          ProductionOrderStatus @default(PLANNED)
  priority        Int                   @default(3) // 1=Urgente, 2=Alta, 3=Normal, 4=Baixa
  
  // Referências
  salesOrderNumber String?              // pedido de venda
  customerName    String?               // cliente
  
  // Observações
  notes           String?
  
  // Auditoria
  createdBy       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Relações
  materials       ProductionOrderMaterial[]
  operations      ProductionOrderOperation[]
  productionLogs  ProductionLog[]
  salesOrderItems SalesOrderItem[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([productId])
  @@map("production_orders")
}

model ProductionOrderMaterial {
  id              String            @id @default(uuid())
  orderId         String
  order           ProductionOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Material
  materialId      String
  material        Material          @relation("ProductionMaterial", fields: [materialId], references: [id])
  
  // Quantidades
  requiredQty     Float             // quantidade necessária
  consumedQty     Float             @default(0) // quantidade consumida
  
  // Custo
  unitCost        Float             @default(0)
  totalCost       Float             @default(0)
  
  notes           String?
  createdAt       DateTime          @default(now())
  
  @@index([orderId])
  @@index([materialId])
  @@map("production_order_materials")
}

model ProductionOrderOperation {
  id              String            @id @default(uuid())
  orderId         String
  order           ProductionOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Operação
  sequence        Int               // sequência da operação
  name            String            // nome da operação
  workCenter      String?           // centro de trabalho
  
  // Tempos planejados (minutos)
  setupTime       Float             @default(0) // tempo de setup
  runTime         Float             @default(0) // tempo de execução por unidade
  
  // Tempos reais
  actualSetupTime Float             @default(0)
  actualRunTime   Float             @default(0)
  
  // Quantidades
  plannedQty      Float             // quantidade planejada
  completedQty    Float             @default(0) // quantidade concluída
  scrapQty        Float             @default(0) // quantidade refugada
  
  // Status
  startedAt       DateTime?
  completedAt     DateTime?
  
  notes           String?
  createdAt       DateTime          @default(now())
  
  @@index([orderId])
  @@map("production_order_operations")
}

// =============================================================================
// MÓDULO FINANCEIRO EXPANDIDO
// =============================================================================

enum BankAccountType {
  CHECKING    // Conta Corrente
  SAVINGS     // Poupança
  INVESTMENT  // Investimento
  CASH        // Caixa
}

enum ReceivableStatus {
  PENDING     // Pendente
  PARTIAL     // Parcialmente pago
  PAID        // Pago
  OVERDUE     // Vencido
  CANCELLED   // Cancelado
  WRITTEN_OFF // Baixado como prejuízo
}

enum ReceivableType {
  INVOICE     // Nota Fiscal
  SERVICE     // Serviço
  CONTRACT    // Contrato
  OTHER       // Outros
}

enum ApprovalStatus {
  PENDING     // Aguardando
  APPROVED    // Aprovado
  REJECTED    // Rejeitado
  CANCELLED   // Cancelado
}

enum BankTransactionType {
  CREDIT        // Crédito
  DEBIT         // Débito
  TRANSFER_IN   // Transferência entrada
  TRANSFER_OUT  // Transferência saída
  FEE           // Taxa
  INTEREST      // Juros
  ADJUSTMENT    // Ajuste
}

// =============================================================================
// CENTRO DE CUSTO
// =============================================================================
model CostCenter {
  id          String    @id @default(uuid()) @db.Uuid
  code        String
  name        String
  description String?
  parentId    String?   @db.Uuid
  parent      CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children    CostCenter[] @relation("CostCenterHierarchy")
  companyId   String?   @db.Uuid
  company     Company?  @relation(fields: [companyId], references: [id])
  isActive    Boolean   @default(true)
  budget      Float?    @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  payableAllocations PayableCostAllocation[]
  receivables        AccountsReceivable[]
  departments        Department[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([parentId])
  @@map("cost_centers")
}

// =============================================================================
// CONTAS BANCÁRIAS
// =============================================================================
model BankAccount {
  id              String          @id @default(uuid()) @db.Uuid
  code            String
  name            String
  bankCode        String?
  bankName        String?
  agency          String?
  agencyDigit     String?
  accountNumber   String?
  accountDigit    String?
  accountType     BankAccountType @default(CHECKING)
  companyId       String?         @db.Uuid
  company         Company?        @relation(fields: [companyId], references: [id])
  initialBalance  Float           @default(0)
  currentBalance  Float           @default(0)
  creditLimit     Float?          @default(0)
  isActive        Boolean         @default(true)
  isDefault       Boolean         @default(false)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  transactions        BankTransaction[]
  payablePayments     PayablePayment[]   @relation("PaymentBankAccount")
  receivablePayments  ReceivablePayment[]
  receivables         AccountsReceivable[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@map("bank_accounts")
}

// =============================================================================
// TRANSAÇÕES BANCÁRIAS
// =============================================================================
model BankTransaction {
  id                  String              @id @default(uuid()) @db.Uuid
  bankAccountId       String              @db.Uuid
  bankAccount         BankAccount         @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  transactionDate     DateTime
  type                BankTransactionType
  description         String
  value               Float
  balanceAfter        Float
  documentNumber      String?
  payableId           String?             @db.Uuid
  payable             AccountsPayable?    @relation(fields: [payableId], references: [id])
  receivableId        String?             @db.Uuid
  receivable          AccountsReceivable? @relation(fields: [receivableId], references: [id])
  transferToAccountId String?             @db.Uuid
  reconciled          Boolean             @default(false)
  reconciledAt        DateTime?
  reconciledBy        String?             @db.Uuid
  externalId          String?
  notes               String?
  createdBy           String?             @db.Uuid
  createdAt           DateTime            @default(now())
  
  payablePayments     PayablePayment[]
  receivablePayments  ReceivablePayment[]
  
  @@index([bankAccountId])
  @@index([transactionDate])
  @@index([payableId])
  @@index([receivableId])
  @@index([reconciled])
  @@map("bank_transactions")
}

// =============================================================================
// CLIENTES
// =============================================================================
model Customer {
  id                    String    @id @default(uuid()) @db.Uuid
  code                  String
  companyId             String?   @db.Uuid
  company               Company?  @relation(fields: [companyId], references: [id])
  type                  String    @default("COMPANY")
  companyName           String
  tradeName             String?
  cnpj                  String?
  cpf                   String?
  stateRegistration     String?
  municipalRegistration String?
  email                 String?
  phone                 String?
  mobile                String?
  website               String?
  contactName           String?
  addressStreet         String?
  addressNumber         String?
  addressComplement     String?
  addressNeighborhood   String?
  addressCity           String?
  addressState          String?
  addressZipCode        String?
  creditLimit           Float?    @default(0)
  paymentTermDays       Int?      @default(30)
  status                String    @default("ACTIVE")
  notes                 String?
  isShared              Boolean   @default(false)
  createdBy             String?   @db.Uuid
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  receivables  AccountsReceivable[]
  leads        Lead[]
  salesQuotes  SalesQuote[]
  salesOrders  SalesOrder[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([cnpj])
  @@index([status])
  @@map("customers")
}

// =============================================================================
// CONTAS A RECEBER
// =============================================================================
model AccountsReceivable {
  id                String           @id @default(uuid()) @db.Uuid
  code              Int
  companyId         String?          @db.Uuid
  company           Company?         @relation(fields: [companyId], references: [id])
  customerId        String           @db.Uuid
  customer          Customer         @relation(fields: [customerId], references: [id])
  documentType      ReceivableType   @default(INVOICE)
  documentNumber    String?
  documentId        String?          @db.Uuid
  description       String
  dueDate           DateTime
  issueDate         DateTime         @default(now())
  originalValue     Float
  discountValue     Float            @default(0)
  interestValue     Float            @default(0)
  fineValue         Float            @default(0)
  paidValue         Float            @default(0)
  netValue          Float
  status            ReceivableStatus @default(PENDING)
  paidAt            DateTime?
  installmentNumber Int              @default(1)
  totalInstallments Int              @default(1)
  categoryId        String?          @db.Uuid
  costCenterId      String?          @db.Uuid
  costCenter        CostCenter?      @relation(fields: [costCenterId], references: [id])
  bankAccountId     String?          @db.Uuid
  bankAccount       BankAccount?     @relation(fields: [bankAccountId], references: [id])
  boletoNumber      String?
  boletoBarcode     String?
  boletoUrl         String?
  pixCode           String?
  notes             String?
  createdBy         String?          @db.Uuid
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  payments          ReceivablePayment[]
  bankTransactions  BankTransaction[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_receivable")
}

// =============================================================================
// PAGAMENTOS DE CONTAS A RECEBER
// =============================================================================
model ReceivablePayment {
  id                String             @id @default(uuid()) @db.Uuid
  receivableId      String             @db.Uuid
  receivable        AccountsReceivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  paymentDate       DateTime
  value             Float
  discountValue     Float              @default(0)
  interestValue     Float              @default(0)
  fineValue         Float              @default(0)
  paymentMethod     String?
  bankAccountId     String?            @db.Uuid
  bankAccount       BankAccount?       @relation(fields: [bankAccountId], references: [id])
  bankTransactionId String?            @db.Uuid
  bankTransaction   BankTransaction?   @relation(fields: [bankTransactionId], references: [id])
  notes             String?
  createdBy         String?            @db.Uuid
  createdAt         DateTime           @default(now())
  
  @@index([receivableId])
  @@index([paymentDate])
  @@map("receivable_payments")
}

// =============================================================================
// APROVAÇÕES DE PAGAMENTO
// =============================================================================
model PayableApproval {
  id          String          @id @default(uuid()) @db.Uuid
  payableId   String          @db.Uuid
  payable     AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  approverId  String          @db.Uuid
  approver    User            @relation(fields: [approverId], references: [id])
  level       Int             @default(1)
  status      ApprovalStatus  @default(PENDING)
  approvedAt  DateTime?
  comments    String?
  createdAt   DateTime        @default(now())
  
  @@index([payableId])
  @@index([approverId])
  @@index([status])
  @@map("payable_approvals")
}

// =============================================================================
// ANEXOS DE CONTAS A PAGAR
// =============================================================================
model PayableAttachment {
  id          String          @id @default(uuid()) @db.Uuid
  payableId   String          @db.Uuid
  payable     AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  fileName    String
  fileType    String
  fileSize    Int
  fileUrl     String
  description String?
  uploadedBy  String?         @db.Uuid
  createdAt   DateTime        @default(now())
  
  @@index([payableId])
  @@map("payable_attachments")
}

// =============================================================================
// RATEIO DE CONTAS A PAGAR
// =============================================================================
model PayableCostAllocation {
  id           String          @id @default(uuid()) @db.Uuid
  payableId    String          @db.Uuid
  payable      AccountsPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  costCenterId String          @db.Uuid
  costCenter   CostCenter      @relation(fields: [costCenterId], references: [id])
  percentage   Float
  value        Float
  createdAt    DateTime        @default(now())
  
  @@index([payableId])
  @@index([costCenterId])
  @@map("payable_cost_allocations")
}

// =============================================================================
// ALÇADAS DE APROVAÇÃO
// =============================================================================
model ApprovalThreshold {
  id                String    @id @default(uuid()) @db.Uuid
  companyId         String?   @db.Uuid
  company           Company?  @relation(fields: [companyId], references: [id])
  name              String
  minValue          Float     @default(0)
  maxValue          Float?
  requiredApprovers Int       @default(1)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  approvers ApprovalThresholdApprover[]
  
  @@index([companyId])
  @@map("approval_thresholds")
}

// =============================================================================
// APROVADORES POR ALÇADA
// =============================================================================
model ApprovalThresholdApprover {
  id          String            @id @default(uuid()) @db.Uuid
  thresholdId String            @db.Uuid
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  userId      String            @db.Uuid
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  level       Int               @default(1)
  createdAt   DateTime          @default(now())
  
  @@index([thresholdId])
  @@index([userId])
  @@map("approval_threshold_approvers")
}

// =============================================================================
// MÓDULO MRP - PLANEJAMENTO DE NECESSIDADES
// =============================================================================

enum MrpSuggestionType {
  PRODUCTION  // Ordem de produção
  PURCHASE    // Ordem de compra
  RESCHEDULE  // Reprogramar
  CANCEL      // Cancelar
}

enum MrpSuggestionStatus {
  PENDING     // Pendente
  APPROVED    // Aprovada
  REJECTED    // Rejeitada
  CONVERTED   // Convertida em ordem
}

enum StopType {
  PLANNED     // Parada planejada
  UNPLANNED   // Parada não planejada
  SETUP       // Setup
  MAINTENANCE // Manutenção
  QUALITY     // Qualidade
  MATERIAL    // Falta de material
  OTHER       // Outros
}

// =============================================================================
// ESTRUTURA DE PRODUTO (BOM)
// =============================================================================
model BomItem {
  id               String   @id @default(uuid()) @db.Uuid
  parentMaterialId String   @db.Uuid
  parentMaterial   Material @relation("BomParent", fields: [parentMaterialId], references: [id], onDelete: Cascade)
  childMaterialId  String   @db.Uuid
  childMaterial    Material @relation("BomChild", fields: [childMaterialId], references: [id])
  quantity         Float
  unit             String   @default("UN")
  scrapPercentage  Float    @default(0)
  leadTimeDays     Int      @default(0)
  sequence         Int      @default(0)
  notes            String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([parentMaterialId, childMaterialId])
  @@index([parentMaterialId])
  @@index([childMaterialId])
  @@map("bom_items")
}

// =============================================================================
// PARÂMETROS MRP
// =============================================================================
model MrpParameter {
  id                     String   @id @default(uuid()) @db.Uuid
  materialId             String   @unique @db.Uuid
  material               Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  minLotSize             Float    @default(1)
  lotMultiple            Float    @default(1)
  safetyStock            Float    @default(0)
  productionLeadTimeDays Int      @default(1)
  purchaseLeadTimeDays   Int      @default(7)
  orderPolicy            String   @default("LOT_FOR_LOT")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  @@index([materialId])
  @@map("mrp_parameters")
}

// =============================================================================
// EXECUÇÕES MRP
// =============================================================================
model MrpRun {
  id                    String          @id @default(uuid()) @db.Uuid
  companyId             String?         @db.Uuid
  company               Company?        @relation(fields: [companyId], references: [id])
  runDate               DateTime        @default(now())
  horizonDays           Int             @default(30)
  status                String          @default("RUNNING")
  totalSuggestions      Int             @default(0)
  productionSuggestions Int             @default(0)
  purchaseSuggestions   Int             @default(0)
  completedAt           DateTime?
  createdBy             String?         @db.Uuid
  notes                 String?
  
  suggestions MrpSuggestion[]
  
  @@index([companyId])
  @@index([runDate])
  @@map("mrp_runs")
}

// =============================================================================
// SUGESTÕES MRP
// =============================================================================
model MrpSuggestion {
  id               String              @id @default(uuid()) @db.Uuid
  runId            String              @db.Uuid
  run              MrpRun              @relation(fields: [runId], references: [id], onDelete: Cascade)
  materialId       String              @db.Uuid
  material         Material            @relation(fields: [materialId], references: [id])
  type             MrpSuggestionType
  status           MrpSuggestionStatus @default(PENDING)
  suggestedDate    DateTime
  requiredDate     DateTime
  quantity         Float
  sourceOrderId    String?             @db.Uuid
  sourceOrderType  String?
  reason           String?
  convertedOrderId String?             @db.Uuid
  convertedAt      DateTime?
  approvedBy       String?             @db.Uuid
  approvedAt       DateTime?
  rejectedBy       String?             @db.Uuid
  rejectedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime            @default(now())
  
  @@index([runId])
  @@index([materialId])
  @@index([status])
  @@index([type])
  @@map("mrp_suggestions")
}

// =============================================================================
// CENTROS DE TRABALHO
// =============================================================================
model WorkCenter {
  id               String   @id @default(uuid()) @db.Uuid
  code             String
  name             String
  description      String?
  companyId        String?  @db.Uuid
  company          Company? @relation(fields: [companyId], references: [id])
  capacityPerHour  Float    @default(1)
  hoursPerDay      Float    @default(8)
  daysPerWeek      Int      @default(5)
  efficiencyTarget Float    @default(85)
  setupTimeMinutes Int      @default(0)
  costPerHour      Float    @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  productionLogs ProductionLog[]
  machineStops   MachineStop[]
  oeeTargets     OeeTarget[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@map("work_centers")
}

// =============================================================================
// REGISTROS DE PRODUÇÃO (OEE)
// =============================================================================
model ProductionLog {
  id                    String           @id @default(uuid()) @db.Uuid
  workCenterId          String           @db.Uuid
  workCenter            WorkCenter       @relation(fields: [workCenterId], references: [id])
  productionOrderId     String?          @db.Uuid
  productionOrder       ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  operatorId            String?          @db.Uuid
  shiftDate             DateTime         @db.Date
  shiftNumber           Int              @default(1)
  plannedQuantity       Float            @default(0)
  producedQuantity      Float            @default(0)
  goodQuantity          Float            @default(0)
  scrapQuantity         Float            @default(0)
  reworkQuantity        Float            @default(0)
  plannedTimeMinutes    Int              @default(0)
  actualTimeMinutes     Int              @default(0)
  setupTimeMinutes      Int              @default(0)
  runTimeMinutes        Int              @default(0)
  stopTimeMinutes       Int              @default(0)
  cycleTimeSeconds      Float?
  idealCycleTimeSeconds Float?
  notes                 String?
  createdBy             String?          @db.Uuid
  createdAt             DateTime         @default(now())
  
  machineStops MachineStop[]
  
  @@index([workCenterId])
  @@index([shiftDate])
  @@index([productionOrderId])
  @@map("production_logs")
}

// =============================================================================
// PARADAS DE MÁQUINA
// =============================================================================
model MachineStop {
  id              String         @id @default(uuid()) @db.Uuid
  workCenterId    String         @db.Uuid
  workCenter      WorkCenter     @relation(fields: [workCenterId], references: [id])
  productionLogId String?        @db.Uuid
  productionLog   ProductionLog? @relation(fields: [productionLogId], references: [id])
  stopType        StopType
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?
  reason          String
  solution        String?
  reportedBy      String?        @db.Uuid
  createdAt       DateTime       @default(now())
  
  @@index([workCenterId])
  @@index([startTime])
  @@index([stopType])
  @@map("machine_stops")
}

// =============================================================================
// METAS OEE
// =============================================================================
model OeeTarget {
  id                 String      @id @default(uuid()) @db.Uuid
  companyId          String?     @db.Uuid
  company            Company?    @relation(fields: [companyId], references: [id])
  workCenterId       String?     @db.Uuid
  workCenter         WorkCenter? @relation(fields: [workCenterId], references: [id], onDelete: Cascade)
  year               Int
  month              Int?
  availabilityTarget Float       @default(90)
  performanceTarget  Float       @default(95)
  qualityTarget      Float       @default(99)
  oeeTarget          Float       @default(85)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  
  @@index([companyId])
  @@index([workCenterId])
  @@index([year, month])
  @@map("oee_targets")
}

// =============================================================================
// MÓDULO DE VENDAS
// =============================================================================

enum LeadStatus {
  NEW         // Novo
  CONTACTED   // Contatado
  QUALIFIED   // Qualificado
  PROPOSAL    // Proposta
  NEGOTIATION // Negociação
  WON         // Ganho
  LOST        // Perdido
}

enum LeadSource {
  WEBSITE     // Site
  REFERRAL    // Indicação
  COLD_CALL   // Prospecção
  TRADE_SHOW  // Feira
  SOCIAL_MEDIA // Redes Sociais
  EMAIL       // Email
  OTHER       // Outros
}

enum SalesQuoteStatus {
  DRAFT       // Rascunho
  SENT        // Enviado
  VIEWED      // Visualizado
  ACCEPTED    // Aceito
  REJECTED    // Rejeitado
  EXPIRED     // Expirado
  CONVERTED   // Convertido
}

enum SalesOrderStatus {
  PENDING       // Pendente
  CONFIRMED     // Confirmado
  IN_PRODUCTION // Em Produção
  READY         // Pronto
  SHIPPED       // Enviado
  DELIVERED     // Entregue
  CANCELLED     // Cancelado
}

// =============================================================================
// LEADS / OPORTUNIDADES
// =============================================================================
model Lead {
  id                String      @id @default(uuid()) @db.Uuid
  code              String
  companyId         String?     @db.Uuid
  company           Company?    @relation(fields: [companyId], references: [id])
  customerId        String?     @db.Uuid
  customer          Customer?   @relation(fields: [customerId], references: [id])
  companyName       String
  contactName       String?
  email             String?
  phone             String?
  source            LeadSource  @default(OTHER)
  status            LeadStatus  @default(NEW)
  estimatedValue    Float?
  probability       Int?        @default(50)
  expectedCloseDate DateTime?
  description       String?
  notes             String?
  assignedTo        String?     @db.Uuid
  assignedUser      User?       @relation(fields: [assignedTo], references: [id])
  lastContactAt     DateTime?
  wonAt             DateTime?
  lostAt            DateTime?
  lostReason        String?
  createdBy         String?     @db.Uuid
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  activities  LeadActivity[]
  salesQuotes SalesQuote[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([assignedTo])
  @@map("leads")
}

// =============================================================================
// ATIVIDADES DO LEAD
// =============================================================================
model LeadActivity {
  id          String    @id @default(uuid()) @db.Uuid
  leadId      String    @db.Uuid
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type        String
  subject     String
  description String?
  scheduledAt DateTime?
  completedAt DateTime?
  createdBy   String?   @db.Uuid
  createdAt   DateTime  @default(now())
  
  @@index([leadId])
  @@map("lead_activities")
}

// =============================================================================
// ORÇAMENTOS DE VENDA
// =============================================================================
model SalesQuote {
  id                 String           @id @default(uuid()) @db.Uuid
  code               Int
  companyId          String?          @db.Uuid
  company            Company?         @relation(fields: [companyId], references: [id])
  customerId         String           @db.Uuid
  customer           Customer         @relation(fields: [customerId], references: [id])
  leadId             String?          @db.Uuid
  lead               Lead?            @relation(fields: [leadId], references: [id])
  status             SalesQuoteStatus @default(DRAFT)
  issueDate          DateTime         @default(now())
  validUntil         DateTime?
  deliveryDays       Int?
  paymentTerms       String?
  shippingMethod     String?
  subtotal           Float            @default(0)
  discountPercent    Float            @default(0)
  discountValue      Float            @default(0)
  shippingValue      Float            @default(0)
  taxValue           Float            @default(0)
  totalValue         Float            @default(0)
  notes              String?
  internalNotes      String?
  sentAt             DateTime?
  viewedAt           DateTime?
  acceptedAt         DateTime?
  rejectedAt         DateTime?
  rejectionReason    String?
  convertedToOrderId String?          @unique @db.Uuid
  convertedToOrder   SalesOrder?      @relation("QuoteToOrder", fields: [convertedToOrderId], references: [id])
  createdBy          String?          @db.Uuid
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  items SalesQuoteItem[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("sales_quotes")
}

// =============================================================================
// ITENS DO ORÇAMENTO DE VENDA
// =============================================================================
model SalesQuoteItem {
  id              String     @id @default(uuid()) @db.Uuid
  quoteId         String     @db.Uuid
  quote           SalesQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  materialId      String     @db.Uuid
  material        Material   @relation(fields: [materialId], references: [id])
  description     String?
  quantity        Float
  unit            String     @default("UN")
  unitPrice       Float
  discountPercent Float      @default(0)
  totalPrice      Float
  sequence        Int        @default(0)
  notes           String?
  createdAt       DateTime   @default(now())
  
  @@index([quoteId])
  @@map("sales_quote_items")
}

// =============================================================================
// PEDIDOS DE VENDA
// =============================================================================
model SalesOrder {
  id                 String           @id @default(uuid()) @db.Uuid
  code               Int
  companyId          String?          @db.Uuid
  company            Company?         @relation(fields: [companyId], references: [id])
  customerId         String           @db.Uuid
  customer           Customer         @relation(fields: [customerId], references: [id])
  quoteId            String?          @db.Uuid
  status             SalesOrderStatus @default(PENDING)
  orderDate          DateTime         @default(now())
  deliveryDate       DateTime?
  shippedAt          DateTime?
  deliveredAt        DateTime?
  paymentTerms       String?
  shippingMethod     String?
  shippingAddress    String?
  subtotal           Float            @default(0)
  discountPercent    Float            @default(0)
  discountValue      Float            @default(0)
  shippingValue      Float            @default(0)
  taxValue           Float            @default(0)
  totalValue         Float            @default(0)
  notes              String?
  internalNotes      String?
  invoiceNumber      String?
  invoiceDate        DateTime?
  trackingCode       String?
  cancelledAt        DateTime?
  cancellationReason String?
  createdBy          String?          @db.Uuid
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  items       SalesOrderItem[]
  sourceQuote SalesQuote?      @relation("QuoteToOrder")
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("sales_orders")
}

// =============================================================================
// ITENS DO PEDIDO DE VENDA
// =============================================================================
model SalesOrderItem {
  id                String           @id @default(uuid()) @db.Uuid
  orderId           String           @db.Uuid
  order             SalesOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  materialId        String           @db.Uuid
  material          Material         @relation(fields: [materialId], references: [id])
  description       String?
  quantity          Float
  deliveredQty      Float            @default(0)
  unit              String           @default("UN")
  unitPrice         Float
  discountPercent   Float            @default(0)
  totalPrice        Float
  sequence          Int              @default(0)
  productionOrderId String?          @db.Uuid
  productionOrder   ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  notes             String?
  createdAt         DateTime         @default(now())
  
  @@index([orderId])
  @@map("sales_order_items")
}

// =============================================================================
// MÓDULO DE ESTOQUE AVANÇADO
// =============================================================================

enum TransferStatus {
  PENDING     // Pendente
  IN_TRANSIT  // Em Trânsito
  RECEIVED    // Recebido
  CANCELLED   // Cancelado
}

enum LocationType {
  WAREHOUSE   // Almoxarifado
  PRODUCTION  // Produção
  QUALITY     // Qualidade
  SHIPPING    // Expedição
  RECEIVING   // Recebimento
  EXTERNAL    // Externo
}

// =============================================================================
// LOCAIS DE ESTOQUE
// =============================================================================
model StockLocation {
  id          String       @id @default(uuid()) @db.Uuid
  code        String
  name        String
  description String?
  type        LocationType @default(WAREHOUSE)
  parentId    String?      @db.Uuid
  parent      StockLocation?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    StockLocation[] @relation("LocationHierarchy")
  companyId   String?      @db.Uuid
  company     Company?     @relation(fields: [companyId], references: [id])
  address     String?
  isActive    Boolean      @default(true)
  isDefault   Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  locationInventory    LocationInventory[]
  transfersFrom        StockTransfer[]      @relation("TransferFrom")
  transfersTo          StockTransfer[]      @relation("TransferTo")
  physicalInventories  PhysicalInventory[]
  inventoryCounts      InventoryCount[]
  materialReceivings   MaterialReceiving[]
  receivingItems       MaterialReceivingItem[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([type])
  @@map("stock_locations")
}

// =============================================================================
// ESTOQUE POR LOCAL
// =============================================================================
model LocationInventory {
  id             String        @id @default(uuid()) @db.Uuid
  locationId     String        @db.Uuid
  location       StockLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  materialId     String        @db.Uuid
  material       Material      @relation(fields: [materialId], references: [id], onDelete: Cascade)
  quantity       Float         @default(0)
  reservedQty    Float         @default(0)
  minQuantity    Float         @default(0)
  maxQuantity    Float?
  lastMovementAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@unique([locationId, materialId])
  @@index([locationId])
  @@index([materialId])
  @@map("location_inventory")
}

// =============================================================================
// TRANSFERÊNCIAS DE ESTOQUE
// =============================================================================
model StockTransfer {
  id                 String         @id @default(uuid()) @db.Uuid
  code               Int
  companyId          String?        @db.Uuid
  company            Company?       @relation(fields: [companyId], references: [id])
  fromLocationId     String         @db.Uuid
  fromLocation       StockLocation  @relation("TransferFrom", fields: [fromLocationId], references: [id])
  toLocationId       String         @db.Uuid
  toLocation         StockLocation  @relation("TransferTo", fields: [toLocationId], references: [id])
  status             TransferStatus @default(PENDING)
  requestedAt        DateTime       @default(now())
  requestedBy        String?        @db.Uuid
  requestedByUser    User?          @relation("TransferRequested", fields: [requestedBy], references: [id])
  approvedAt         DateTime?
  approvedBy         String?        @db.Uuid
  approvedByUser     User?          @relation("TransferApproved", fields: [approvedBy], references: [id])
  shippedAt          DateTime?
  shippedBy          String?        @db.Uuid
  shippedByUser      User?          @relation("TransferShipped", fields: [shippedBy], references: [id])
  receivedAt         DateTime?
  receivedBy         String?        @db.Uuid
  receivedByUser     User?          @relation("TransferReceived", fields: [receivedBy], references: [id])
  cancelledAt        DateTime?
  cancelledBy        String?        @db.Uuid
  cancellationReason String?
  notes              String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  
  items StockTransferItem[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([status])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@map("stock_transfers")
}

// =============================================================================
// ITENS DA TRANSFERÊNCIA
// =============================================================================
model StockTransferItem {
  id           String        @id @default(uuid()) @db.Uuid
  transferId   String        @db.Uuid
  transfer     StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  materialId   String        @db.Uuid
  material     Material      @relation(fields: [materialId], references: [id])
  requestedQty Float
  shippedQty   Float         @default(0)
  receivedQty  Float         @default(0)
  unit         String        @default("UN")
  notes        String?
  createdAt    DateTime      @default(now())
  
  @@index([transferId])
  @@map("stock_transfer_items")
}

// =============================================================================
// WORKFLOW DE APROVAÇÃO DE REQUISIÇÕES
// =============================================================================
model RequisitionApproval {
  id            String             @id @default(uuid()) @db.Uuid
  requisitionId String             @db.Uuid
  requisition   MaterialRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  level         Int                @default(1)
  approverId    String             @db.Uuid
  approver      User               @relation(fields: [approverId], references: [id])
  status        ApprovalStatus     @default(PENDING)
  approvedAt    DateTime?
  rejectedAt    DateTime?
  comments      String?
  createdAt     DateTime           @default(now())
  
  @@index([requisitionId])
  @@index([approverId])
  @@index([status])
  @@map("requisition_approvals")
}

// =============================================================================
// INVENTÁRIO FÍSICO (CONTAGEM)
// =============================================================================
model PhysicalInventory {
  id          String         @id @default(uuid()) @db.Uuid
  code        Int
  companyId   String?        @db.Uuid
  company     Company?       @relation(fields: [companyId], references: [id])
  locationId  String?        @db.Uuid
  location    StockLocation? @relation(fields: [locationId], references: [id])
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime?
  status      String         @default("OPEN")
  createdBy   String?        @db.Uuid
  closedBy    String?        @db.Uuid
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  counts InventoryCount[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([status])
  @@map("physical_inventories")
}

// =============================================================================
// CONTAGENS DO INVENTÁRIO
// =============================================================================
model InventoryCount {
  id          String            @id @default(uuid()) @db.Uuid
  inventoryId String            @db.Uuid
  inventory   PhysicalInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  materialId  String            @db.Uuid
  material    Material          @relation(fields: [materialId], references: [id])
  locationId  String?           @db.Uuid
  location    StockLocation?    @relation(fields: [locationId], references: [id])
  systemQty   Float             @default(0)
  countedQty  Float?
  difference  Float?
  countedBy   String?           @db.Uuid
  countedAt   DateTime?
  verified    Boolean           @default(false)
  verifiedBy  String?           @db.Uuid
  verifiedAt  DateTime?
  notes       String?
  createdAt   DateTime          @default(now())
  
  @@index([inventoryId])
  @@index([materialId])
  @@map("inventory_counts")
}

// =============================================================================
// MÓDULO DE RH
// =============================================================================

enum ContractType {
  CLT         // CLT
  PJ          // Pessoa Jurídica
  TEMPORARY   // Temporário
  INTERN      // Estagiário
  APPRENTICE  // Aprendiz
}

enum EmployeeStatus {
  ACTIVE      // Ativo
  VACATION    // Férias
  LEAVE       // Afastado
  SUSPENDED   // Suspenso
  TERMINATED  // Desligado
}

enum TimeClockType {
  CLOCK_IN    // Entrada
  CLOCK_OUT   // Saída
  BREAK_START // Início Intervalo
  BREAK_END   // Fim Intervalo
}

enum PayrollEventType {
  SALARY      // Salário
  OVERTIME    // Hora Extra
  BONUS       // Bônus
  COMMISSION  // Comissão
  ALLOWANCE   // Adicional
  DEDUCTION   // Desconto
  TAX         // Imposto
  BENEFIT     // Benefício
}

// =============================================================================
// DEPARTAMENTOS
// =============================================================================
model Department {
  id           String       @id @default(uuid()) @db.Uuid
  code         String
  name         String
  description  String?
  managerId    String?      @db.Uuid
  parentId     String?      @db.Uuid
  parent       Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children     Department[] @relation("DepartmentHierarchy")
  companyId    String?      @db.Uuid
  company      Company?     @relation(fields: [companyId], references: [id])
  costCenterId String?      @db.Uuid
  costCenter   CostCenter?  @relation(fields: [costCenterId], references: [id])
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  positions JobPosition[]
  employees Employee[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@map("departments")
}

// =============================================================================
// CARGOS
// =============================================================================
model JobPosition {
  id           String      @id @default(uuid()) @db.Uuid
  code         String
  name         String
  description  String?
  departmentId String?     @db.Uuid
  department   Department? @relation(fields: [departmentId], references: [id])
  companyId    String?     @db.Uuid
  company      Company?    @relation(fields: [companyId], references: [id])
  baseSalary   Float?
  level        Int?        @default(1)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  employees Employee[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@map("job_positions")
}

// =============================================================================
// FUNCIONÁRIOS
// =============================================================================
model Employee {
  id                  String         @id @default(uuid()) @db.Uuid
  code                Int
  companyId           String?        @db.Uuid
  company             Company?       @relation(fields: [companyId], references: [id])
  userId              String?        @db.Uuid
  user                User?          @relation(fields: [userId], references: [id])
  name                String
  cpf                 String?
  rg                  String?
  birthDate           DateTime?      @db.Date
  gender              String?
  maritalStatus       String?
  email               String?
  phone               String?
  mobile              String?
  address             String?
  addressNumber       String?
  addressComplement   String?
  addressNeighborhood String?
  addressCity         String?
  addressState        String?
  addressZipCode      String?
  departmentId        String?        @db.Uuid
  department          Department?    @relation(fields: [departmentId], references: [id])
  positionId          String?        @db.Uuid
  position            JobPosition?   @relation(fields: [positionId], references: [id])
  managerId           String?        @db.Uuid
  manager             Employee?      @relation("EmployeeManager", fields: [managerId], references: [id])
  subordinates        Employee[]     @relation("EmployeeManager")
  contractType        ContractType   @default(CLT)
  status              EmployeeStatus @default(ACTIVE)
  hireDate            DateTime       @db.Date
  terminationDate     DateTime?      @db.Date
  salary              Float          @default(0)
  workHoursPerDay     Float          @default(8)
  workDaysPerWeek     Int            @default(5)
  bankName            String?
  bankBranch          String?
  bankAccount         String?
  bankAccountType     String?
  pixKey              String?
  pis                 String?
  ctps                String?
  voterRegistration   String?
  militaryService     String?
  notes               String?
  photo               String?
  createdBy           String?        @db.Uuid
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  timeClockEntries TimeClockEntry[]
  timesheetDays    TimesheetDay[]
  payrollItems     PayrollItem[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([departmentId])
  @@index([status])
  @@map("employees")
}

// =============================================================================
// REGISTROS DE PONTO
// =============================================================================
model TimeClockEntry {
  id            String        @id @default(uuid()) @db.Uuid
  employeeId    String        @db.Uuid
  employee      Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type          TimeClockType
  timestamp     DateTime
  location      String?
  latitude      Float?
  longitude     Float?
  deviceId      String?
  ipAddress     String?
  isManual      Boolean       @default(false)
  justification String?
  approvedBy    String?       @db.Uuid
  approvedAt    DateTime?
  createdAt     DateTime      @default(now())
  
  @@index([employeeId])
  @@index([timestamp])
  @@map("time_clock_entries")
}

// =============================================================================
// FOLHA DE PONTO (RESUMO DIÁRIO)
// =============================================================================
model TimesheetDay {
  id             String    @id @default(uuid()) @db.Uuid
  employeeId     String    @db.Uuid
  employee       Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date           DateTime  @db.Date
  scheduledHours Float     @default(8)
  workedHours    Float     @default(0)
  overtimeHours  Float     @default(0)
  nightHours     Float     @default(0)
  absenceHours   Float     @default(0)
  isHoliday      Boolean   @default(false)
  isWeekend      Boolean   @default(false)
  status         String    @default("PENDING")
  notes          String?
  approvedBy     String?   @db.Uuid
  approvedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("timesheet_days")
}

// =============================================================================
// FOLHA DE PAGAMENTO
// =============================================================================
model Payroll {
  id              String    @id @default(uuid()) @db.Uuid
  code            Int
  companyId       String?   @db.Uuid
  company         Company?  @relation(fields: [companyId], references: [id])
  referenceMonth  Int
  referenceYear   Int
  status          String    @default("DRAFT")
  totalGross      Float     @default(0)
  totalDeductions Float     @default(0)
  totalNet        Float     @default(0)
  employeeCount   Int       @default(0)
  processedAt     DateTime?
  processedBy     String?   @db.Uuid
  approvedAt      DateTime?
  approvedBy      String?   @db.Uuid
  paidAt          DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items PayrollItem[]
  
  @@unique([code, companyId])
  @@unique([companyId, referenceMonth, referenceYear])
  @@index([companyId])
  @@map("payrolls")
}

// =============================================================================
// ITENS DA FOLHA (POR FUNCIONÁRIO)
// =============================================================================
model PayrollItem {
  id              String   @id @default(uuid()) @db.Uuid
  payrollId       String   @db.Uuid
  payroll         Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employeeId      String   @db.Uuid
  employee        Employee @relation(fields: [employeeId], references: [id])
  baseSalary      Float    @default(0)
  workedDays      Int      @default(0)
  workedHours     Float    @default(0)
  overtimeHours   Float    @default(0)
  nightHours      Float    @default(0)
  absenceDays     Int      @default(0)
  grossSalary     Float    @default(0)
  totalDeductions Float    @default(0)
  netSalary       Float    @default(0)
  inss            Float    @default(0)
  irrf            Float    @default(0)
  fgts            Float    @default(0)
  notes           String?
  createdAt       DateTime @default(now())
  
  events PayrollEvent[]
  
  @@unique([payrollId, employeeId])
  @@index([payrollId])
  @@index([employeeId])
  @@map("payroll_items")
}

// =============================================================================
// EVENTOS DA FOLHA (PROVENTOS/DESCONTOS)
// =============================================================================
model PayrollEvent {
  id            String           @id @default(uuid()) @db.Uuid
  payrollItemId String           @db.Uuid
  payrollItem   PayrollItem      @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  type          PayrollEventType
  code          String
  description   String
  reference     Float?
  value         Float
  isDeduction   Boolean          @default(false)
  createdAt     DateTime         @default(now())
  
  @@index([payrollItemId])
  @@map("payroll_events")
}

// =============================================================================
// MÓDULO CP14 - ENTRADA DE MATERIAIS / NFe
// =============================================================================

enum ReceivingStatus {
  PENDING       // Aguardando conferência
  IN_PROGRESS   // Em conferência
  COMPLETED     // Conferido e entrada realizada
  REJECTED      // Rejeitado
  PARTIAL       // Entrada parcial
  CANCELLED     // Cancelado
}

enum ReceivingItemStatus {
  PENDING   // Aguardando
  APPROVED  // Aprovado
  REJECTED  // Rejeitado
  PARTIAL   // Parcial
}

// =============================================================================
// RECEBIMENTOS (CABEÇALHO)
// =============================================================================
model MaterialReceiving {
  id               String          @id @default(uuid()) @db.Uuid
  code             Int
  companyId        String?         @db.Uuid
  company          Company?        @relation(fields: [companyId], references: [id])
  supplierId       String          @db.Uuid
  supplier         Supplier        @relation(fields: [supplierId], references: [id])
  purchaseOrderId  String?         @db.Uuid
  purchaseOrder    PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id])
  invoiceId        String?         @db.Uuid
  invoice          ReceivedInvoice? @relation(fields: [invoiceId], references: [id])
  status           ReceivingStatus @default(PENDING)
  receivingDate    DateTime        @default(now())
  expectedDate     DateTime?
  nfeNumber        String?
  nfeSeries        String?
  nfeKey           String?         @unique
  nfeXml           String?
  nfeIssueDate     DateTime?
  totalValue       Float           @default(0)
  freightValue     Float           @default(0)
  insuranceValue   Float           @default(0)
  discountValue    Float           @default(0)
  otherExpenses    Float           @default(0)
  locationId       String?         @db.Uuid
  location         StockLocation?  @relation(fields: [locationId], references: [id])
  notes            String?
  internalNotes    String?
  conferredBy      String?         @db.Uuid
  conferredAt      DateTime?
  approvedBy       String?         @db.Uuid
  approvedAt       DateTime?
  rejectedBy       String?         @db.Uuid
  rejectedAt       DateTime?
  rejectionReason  String?
  createdBy        String?         @db.Uuid
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  items MaterialReceivingItem[]
  
  @@unique([code, companyId])
  @@index([companyId])
  @@index([supplierId])
  @@index([status])
  @@index([receivingDate])
  @@map("material_receivings")
}

// =============================================================================
// ITENS DO RECEBIMENTO
// =============================================================================
model MaterialReceivingItem {
  id                  String              @id @default(uuid()) @db.Uuid
  receivingId         String              @db.Uuid
  receiving           MaterialReceiving   @relation(fields: [receivingId], references: [id], onDelete: Cascade)
  materialId          String              @db.Uuid
  material            Material            @relation(fields: [materialId], references: [id])
  purchaseOrderItemId String?             @db.Uuid
  purchaseOrderItem   PurchaseOrderItem?  @relation(fields: [purchaseOrderItemId], references: [id])
  nfeItemNumber       Int?
  description         String?
  unit                String              @default("UN")
  nfeQuantity         Float
  receivedQuantity    Float               @default(0)
  approvedQuantity    Float               @default(0)
  rejectedQuantity    Float               @default(0)
  unitPrice           Float
  totalPrice          Float
  icmsBase            Float               @default(0)
  icmsValue           Float               @default(0)
  ipiBase             Float               @default(0)
  ipiValue            Float               @default(0)
  status              ReceivingItemStatus @default(PENDING)
  rejectionReason     String?
  batchNumber         String?
  expirationDate      DateTime?
  certificateNumber   String?
  qualityStatus       String?
  qualityNotes        String?
  locationId          String?             @db.Uuid
  location            StockLocation?      @relation(fields: [locationId], references: [id])
  conferredBy         String?             @db.Uuid
  conferredAt         DateTime?
  notes               String?
  createdAt           DateTime            @default(now())
  
  divergences  ReceivingDivergence[]
  certificates QualityCertificate[]
  
  @@index([receivingId])
  @@index([materialId])
  @@index([status])
  @@map("material_receiving_items")
}

// =============================================================================
// DIVERGÊNCIAS DE RECEBIMENTO
// =============================================================================
model ReceivingDivergence {
  id              String               @id @default(uuid()) @db.Uuid
  receivingItemId String               @db.Uuid
  receivingItem   MaterialReceivingItem @relation(fields: [receivingItemId], references: [id], onDelete: Cascade)
  type            String
  expectedValue   String?
  receivedValue   String?
  description     String
  resolution      String?
  resolvedBy      String?              @db.Uuid
  resolvedAt      DateTime?
  createdAt       DateTime             @default(now())
  
  @@index([receivingItemId])
  @@map("receiving_divergences")
}

// =============================================================================
// CERTIFICADOS DE QUALIDADE
// =============================================================================
model QualityCertificate {
  id              String               @id @default(uuid()) @db.Uuid
  receivingItemId String               @db.Uuid
  receivingItem   MaterialReceivingItem @relation(fields: [receivingItemId], references: [id], onDelete: Cascade)
  certificateNumber String
  issueDate       DateTime?
  expirationDate  DateTime?
  issuer          String?
  fileUrl         String?
  notes           String?
  createdAt       DateTime             @default(now())
  
  @@index([receivingItemId])
  @@map("quality_certificates")
}

// =============================================================================
// TUTORIAIS E DOCUMENTAÇÃO
// =============================================================================
model Tutorial {
  id          String   @id @default(uuid()) @db.Uuid
  slug        String   @unique @db.VarChar(100)
  title       String   @db.VarChar(255)
  description String?
  content     String
  module      String?  @db.VarChar(50)
  category    String?  @db.VarChar(50)
  icon        String?  @db.VarChar(50)
  orderIndex  Int      @default(0) @map("order_index")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String?  @db.Uuid @map("created_by")
  creator     User?    @relation(fields: [createdBy], references: [id])

  @@index([module])
  @@index([category])
  @@map("tutorials")
}
