# An√°lise Complementar FRM-ERP ‚Äî Diretor Industrial + Fiscal/Tribut√°rio

> Complemento ao documento principal de an√°lise.
> Perspectivas: Diretor Industrial (PCP, Produ√ß√£o, Qualidade, Manuten√ß√£o) + Gerente Fiscal/Tribut√°rio
> Data: 09/02/2026

---

## 7. Vis√£o Diretor Industrial ‚Äî PCP, Ch√£o de F√°brica e Qualidade

### 7.1 Estrutura Produtiva Modelada

O sistema modela uma f√°brica com razo√°vel profundidade:

**BOM (Lista de Materiais):** Estrutura pai/filho via `BomItem` (parentMaterialId ‚Üí childMaterialId) com quantidade, scrapPercentage, leadTimeDays, sequ√™ncia. Constraint de unicidade no par pai/filho. Suporta estrutura multin√≠vel. O campo `scrapPercentage` √© importante para rolamentos ‚Äî taxas de refugo variam significativamente por opera√ß√£o (ret√≠fica vs torneamento vs tratamento t√©rmico).

**Ordens de Produ√ß√£o:** ProductionOrder com ciclo de vida completo (PLANNED ‚Üí RELEASED ‚Üí IN_PROGRESS ‚Üí COMPLETED ‚Üí CANCELLED). Campos espec√≠ficos do contexto FRM que evidenciam migra√ß√£o do legado Delphi:
- `request_type`: SALES, STOCK, EXPORT, NORMAL, REWORK ‚Äî distingue fabrica√ß√£o para estoque vs pedido vs exporta√ß√£o vs retrabalho
- `execution_type`: MANUFACTURE vs ALTER ‚Äî fabrica√ß√£o completa vs altera√ß√£o/reprocessamento
- `raw_material_origin`: INDUSTRIALIZED_STOCK, RAW_MATERIAL, FOUNDRY ‚Äî rastreabilidade da origem da mat√©ria-prima (a√ßo fundido vs barras industrializadas)
- `painted_quantity`, `finished_quantity` ‚Äî tracking de etapas intermedi√°rias
- `export_code` ‚Äî integra√ß√£o com comex

**Opera√ß√µes de Produ√ß√£o:** ProductionOrderOperation com setup time + run time (planejado vs real), scrapQty, completedQty. Vinculada a work center por nome (String), n√£o por FK ‚Äî isso √© uma fragilidade.

**Work Centers:** Cadastro com capacidade/hora, horas/dia, dias/semana, efficiency target, custo/hora. Base para c√°lculo de capacidade e custo.

**MES / Apontamento:** ProductionLog captura por turno: planned vs produced vs good vs scrap vs rework quantities, tempos de setup/run/stop, cycle time real vs ideal. MachineStop com classifica√ß√£o (PLANNED, UNPLANNED, SETUP, MAINTENANCE, QUALITY, MATERIAL). Isso alimenta o OEE.

**MRP:** MrpParameter por material (lot sizing, safety stock, lead times) ‚Üí MrpRun ‚Üí MrpSuggestion (PURCHASE ou PRODUCTION) com fluxo de aprova√ß√£o. Order policy LOT_FOR_LOT como default.

### 7.2 Pontos Fortes para Ind√∫stria

**Tipagem da OP reflete a realidade da FRM.** O `production_request_type` com EXPORT e o `raw_material_origin` com FOUNDRY mostram que o modelo foi pensado para as 7 empresas ‚Äî algumas fabricam a partir de fundidos, outras de barras. O campo `export_code` permite rastrear quais OPs geraram produto para exporta√ß√£o (v√≠nculo com comex).

**OEE pronto para dashboard.** ProductionLog + MachineStop + OeeTarget d√° a base para calcular Disponibilidade, Performance e Qualidade por work center, turno e per√≠odo. O ProductionLog j√° tem a granularidade necess√°ria (good vs scrap vs rework).

**Custos de produ√ß√£o detalhados.** ProductionCost com breakdown em materiais (custo real vs padr√£o) e m√£o de obra (horas normais, extras, noturnas com custo individual). MaterialStandardCost com last/average/standard. Permite custeio por absor√ß√£o real e an√°lise de vari√¢ncia.

### 7.3 Gaps Cr√≠ticos para Ind√∫stria

#### üî¥ Sem Rastreabilidade de Lote no Estoque

O `Inventory` n√£o tem campo de lote. √â um saldo agregado por (materialId, companyId, inventoryType). Campos de lote existem pontualmente ‚Äî `PickingListItem.lotNumber`, `MaterialReceivingItem.batchNumber`, `QualityInspection.lotNumber` ‚Äî mas s√£o strings informativas, sem uma entidade `Lot` ou `Batch` que governe o ciclo de vida do lote.

Para uma f√°brica de rolamentos isso √© um problema s√©rio:
- **Clientes automotivos exigem rastreabilidade forward/backward**: dado um lote de rolamentos entregue √† montadora, qual corrida de a√ßo originou? Dado um lote de a√ßo rejeitado no fornecedor, quais rolamentos acabados foram impactados?
- **Recall/recolhimento:** sem rastreabilidade de lote, um recall atinge toda a produ√ß√£o do per√≠odo, n√£o s√≥ os lotes afetados
- **Certificados de qualidade vinculados ao lote:** QualityCertificate existe mas est√° vinculado a MaterialReceivingItem, n√£o a um lote que flui pela cadeia produtiva
- **FIFO/FEFO:** sem lote no estoque, n√£o h√° como garantir First In First Out ou First Expired First Out

**Recomenda√ß√£o:** Criar modelo `InventoryLot` (materialId, companyId, lotNumber, batchDate, expirationDate, quantity, status, origin ‚Äî PURCHASE/PRODUCTION/TRANSFER). O InventoryMovement passa a referenciar o lote. Isso √© arquiteturalmente grande ‚Äî impacta receiving, production, picking, quality.

#### üî¥ Opera√ß√£o Vinculada a Work Center por String, n√£o FK

`ProductionOrderOperation.workCenter` √© `String?`, n√£o FK para `WorkCenter`. Isso significa que a opera√ß√£o aponta para o nome do work center, n√£o para a entidade. Consequ√™ncias:
- Renomear um work center quebra a refer√™ncia
- N√£o √© poss√≠vel fazer queries de capacidade como "quais opera√ß√µes est√£o alocadas no torno CNC-01 esta semana"
- N√£o h√° valida√ß√£o de que o work center existe

**Recomenda√ß√£o:** Adicionar `workCenterId` como FK para WorkCenter. Manter o campo `workCenter` (String) como campo legado para migra√ß√£o, deprecar depois.

#### üü° BOM Sem Roteiro de Fabrica√ß√£o

O BOM tem a estrutura de materiais (o qu√™), mas o roteiro de fabrica√ß√£o (como) est√° solto. As opera√ß√µes s√£o definidas por OP, n√£o por produto. Isso significa que toda vez que se cria uma OP para o rolamento 6205, as opera√ß√µes (torneamento do anel interno, ret√≠fica da pista, montagem, etc.) precisam ser informadas manualmente ou copiadas de uma OP anterior.

O padr√£o industrial √© ter um **roteiro padr√£o** (Routing) vinculado ao material/produto, que √© copiado para a OP ao cri√°-la. Campos: sequ√™ncia, opera√ß√£o, work center, tempo de setup padr√£o, tempo de execu√ß√£o padr√£o por unidade, ferramental necess√°rio.

**Recomenda√ß√£o Fase 2:** Criar model `ProductionRouting` (materialId, version, isActive) e `ProductionRoutingOperation` (routingId, sequence, workCenterId, operationName, standardSetupTime, standardRunTimePerUnit, tooling). A OP copia o roteiro ativo ao ser criada.

#### üü° Sem Cadastro de Ferramental/Moldes

Fabrica√ß√£o de rolamentos usa ferramental espec√≠fico: matrizes de forjamento, ferramentas de corte de ret√≠fica, calibradores. N√£o h√° model para cadastro de ferramental, vida √∫til, vincula√ß√£o ferramenta ‚Üí opera√ß√£o, controle de afia√ß√£o/substitui√ß√£o. O `MachineStop` com tipo SETUP pega parte disso, mas n√£o o ciclo de vida da ferramenta.

#### üü° Sem Tratamento T√©rmico como Entidade

Para rolamentos, o tratamento t√©rmico (cementa√ß√£o, t√™mpera, revenimento) √© uma opera√ß√£o cr√≠tica que define a dureza final. Par√¢metros como temperatura, tempo, atmosfera do forno precisam ser registrados e vinculados ao lote para rastreabilidade. Hoje isso cairia como uma `ProductionOrderOperation` gen√©rica, sem campos para os par√¢metros do processo.

#### üü° Invent√°rio com M√∫ltiplos Saldos Paralelos

O model `Inventory` tem campos curiosos: `quantity`, `quantitySemiFinished`, `quantityFinished`, `quantityCritical`, `quantityScrap`, `quantityDead`, `quantityAccountingInd`, `quantityAccountingResale`, `quantityOnOrder`. S√£o 9 saldos paralelos no mesmo registro. Isso sugere migra√ß√£o do Delphi onde esses saldos eram mantidos manualmente. Em um ERP moderno, esses saldos deveriam ser derivados de `InventoryMovement` (soma de movimentos por tipo) ou de `StockLocation` + `InventoryType`, n√£o armazenados como campos est√°ticos.

O risco √© dessincroniza√ß√£o: um bug que incrementa `quantity` mas n√£o decrementa `quantitySemiFinished` gera saldo irreconcili√°vel. O campo `version` (otimistic locking) ajuda, mas n√£o resolve o problema conceitual.

### 7.4 Maturidade Industrial ‚Äî Resumo

| Capacidade | Status | Nota |
|-----------|--------|------|
| BOM multin√≠vel | ‚úÖ Funcional | Falta roteiro de fabrica√ß√£o vinculado |
| MRP | ‚úÖ Funcional | Lot for lot + safety stock + lead times |
| Ordem de Produ√ß√£o | ‚úÖ Funcional | Tipagem rica (export, rework, fundi√ß√£o) |
| Apontamento/MES | ‚úÖ Funcional | Turno, tempos, scrap, rework |
| OEE | ‚úÖ Funcional | Disponibilidade, performance, qualidade |
| Custo de Produ√ß√£o | ‚úÖ Funcional | Material + MOD real vs padr√£o |
| Rastreabilidade de Lote | ‚ùå Ausente | Campos soltos, sem entidade de lote |
| Roteiro de Fabrica√ß√£o | ‚ùå Ausente | Opera√ß√µes s√£o ad-hoc por OP |
| Manuten√ß√£o (CMMS) | ‚ùå Ausente | S√≥ registro de paradas, sem gest√£o preventiva |
| Controle de Ferramental | ‚ùå Ausente | Sem cadastro de ferramentas/moldes |
| Qualidade (CAPA/8D) | ‚ö†Ô∏è B√°sica | Inspe√ß√£o + NC, sem a√ß√£o corretiva estruturada |
| Rastreabilidade de processo | ‚ö†Ô∏è Parcial | Par√¢metros de processo n√£o estruturados |

---

## 8. Vis√£o Fiscal/Tribut√°rio ‚Äî NF-e, Impostos e Compliance

### 8.1 Cobertura Fiscal

**NF-e de Entrada (ReceivedInvoice):** 62 campos, chave de acesso de 44 d√≠gitos, campos de ICMS, IPI, PIS, COFINS, ICMS-ST, cr√©ditos tribut√°rios (icms_credit, ipi_credit, pis_credit, cofins_credit). Armazena XML completo. V√≠nculo com PurchaseOrder e Supplier.

**NF-e de Sa√≠da (IssuedInvoice):** Modelo para emiss√£o com campos de impostos, modelo 55, access key, protocol number. Fila de emiss√£o via `nfe_queue_jobs`. O `IssuedInvoiceItem` tem CFOP, NCM, bases e al√≠quotas por item ‚Äî **usa Decimal corretamente** (diferente da nota de entrada que usa Float).

**SEFAZ:** Sincroniza√ß√£o autom√°tica configur√°vel por empresa (SefazSyncConfig), notas pendentes de manifesta√ß√£o (SefazPendingNfe), log de manifesta√ß√µes (CIENCIA, CONFIRMACAO, DESCONHECIMENTO, OPERACAO_NAO_REALIZADA). Auto-manifesta√ß√£o configur√°vel.

**DDA:** Integra√ß√£o com D√©bito Direto Autorizado ‚Äî boletos banc√°rios capturados via arquivo banc√°rio (DdaBoleto) com v√≠nculo para AccountsPayable e Supplier. Fluxo de aprova√ß√£o (aprovadoPor, aprovadoEm). **Usa Decimal corretamente.**

**SPED:** Router existe (`spedRouter`), indicando que h√° gera√ß√£o de SPED Fiscal/Contribui√ß√µes, mas n√£o h√° model dedicado ‚Äî provavelmente √© gerado a partir dos dados de NF-e + financeiro.

### 8.2 Problemas Fiscais Cr√≠ticos

#### üî¥ Float nos Valores de Impostos da NF-e de Entrada

A `ReceivedInvoice` e seus itens usam `Float` para todos os valores: totalProducts, totalInvoice, icmsBase, icmsValue, ipiValue, pisValue, cofinsValue, e todos os cr√©ditos. A `IssuedInvoice`, que foi feita depois, usa `Decimal` corretamente.

Essa inconsist√™ncia √© perigosa: os cr√©ditos tribut√°rios (ICMS, IPI, PIS, COFINS) apurados a partir das notas de entrada v√£o ter arredondamento diferente dos d√©bitos apurados a partir das notas de sa√≠da. Na concilia√ß√£o SPED √ó ERP, esses centavos de diferen√ßa geram pend√™ncias.

**Cen√°rio real:** A empresa recebe 500 NF-es/m√™s. A soma dos cr√©ditos de PIS no ERP (Float) pode diferir em R$ 0,50-2,00 da soma que a Receita Federal calcula a partir dos XMLs (que usam casas decimais exatas). Isso gera malha fina no SPED Contribui√ß√µes.

**Recomenda√ß√£o:** Migrar ReceivedInvoice e ReceivedInvoiceItem para Decimal. Prioridade m√°xima junto com os financeiros.

#### üü° Sem Cadastro de CFOP Estruturado

O campo `cfop` √© uma `Int` em ReceivedInvoiceItem e `String` em IssuedInvoiceItem. N√£o h√° tabela de CFOPs v√°lidos com descri√ß√£o, natureza da opera√ß√£o, se gera cr√©dito, se √© interestadual. Isso significa que:
- N√£o h√° valida√ß√£o se o CFOP informado √© v√°lido
- N√£o h√° automatiza√ß√£o de "compra para industrializa√ß√£o = 1101/2101, compra para revenda = 1102/2102"
- Relat√≥rios de entradas por natureza de opera√ß√£o dependem de parsing do CFOP

**Recomenda√ß√£o Fase 2:** Criar tabela `CfopTable` com os ~600 CFOPs v√°lidos, campo `generateCredit`, `operationType`, e usar FK ou valida√ß√£o no item da NF-e.

#### üü° Sem CFOP e CST na NF-e de Entrada por Item

O `ReceivedInvoiceItem` tem `cfop` mas n√£o tem CST (C√≥digo de Situa√ß√£o Tribut√°ria) para ICMS, IPI, PIS, COFINS. O CST √© necess√°rio para:
- Apura√ß√£o correta de cr√©ditos (CST 50 = com cr√©dito, CST 70 = com redu√ß√£o de base)
- Gera√ß√£o do SPED Fiscal (registros C170 exigem CST)
- Classifica√ß√£o de al√≠quota zero, isento, n√£o tributado

Provavelmente os CSTs est√£o sendo extra√≠dos do XML no momento da importa√ß√£o e n√£o persistidos. Se for o caso, a gera√ß√£o do SPED reconstr√≥i a partir do XML, o que funciona mas √© fr√°gil.

#### üü° Sem Tabela de NCM/TIPI

O `Material.ncm` √© String sem valida√ß√£o. A TIPI (Tabela de Incid√™ncia do IPI) vincula NCM ‚Üí al√≠quota de IPI, e o Material tem `ipiRate` como campo. Mas n√£o h√° tabela de NCMs v√°lidos com descri√ß√£o, CEST, al√≠quota IPI padr√£o, ex-tarif√°rio. Isso significa que a al√≠quota IPI √© informada manualmente por material, sem valida√ß√£o cruzada com a TIPI.

#### üü° Regime Tribut√°rio n√£o Modelado

N√£o h√° campo ou config para regime tribut√°rio da empresa (Lucro Real, Lucro Presumido, Simples Nacional). Isso afeta:
- C√°lculo de PIS/COFINS (cumulativo vs n√£o-cumulativo)
- Direito a cr√©ditos de ICMS
- Gera√ß√£o do SPED (registros diferentes por regime)

Como o grupo FRM tem 7 empresas, √© prov√°vel que nem todas estejam no mesmo regime. Uma empresa pode ser Lucro Real e outra Lucro Presumido. Sem essa informa√ß√£o no sistema, as regras fiscais precisam ser hardcoded ou configuradas por empresa via SystemSetting.

#### üü° Sem Apura√ß√£o de Impostos

N√£o h√° model para `TaxPeriod` (per√≠odo de apura√ß√£o), `TaxAppraisal` (apura√ß√£o mensal de ICMS, IPI, PIS, COFINS), ou `TaxGuide` (guia de recolhimento ‚Äî DARE, DARF, GPS). A apura√ß√£o provavelmente √© feita no escrit√≥rio cont√°bil a partir do SPED gerado pelo sistema.

Para a fase 1, isso √© aceit√°vel ‚Äî a maioria dos ERPs de m√©dio porte delega a apura√ß√£o para o fiscal/cont√°bil. Mas √© uma limita√ß√£o para o futuro.

### 8.3 Risco Espec√≠fico: Triangula√ß√£o Fiscal entre Empresas do Grupo

O grupo FRM tem 7 empresas. Transfer√™ncias de mercadoria entre elas (venda entre CNPJs do mesmo grupo) exigem:
- NF-e de sa√≠da da empresa A com CFOP 5.152/6.152 (transfer√™ncia)
- NF-e de entrada na empresa B
- Cr√©dito de ICMS na empresa B
- Poss√≠vel ICMS-ST quando interestadual (PR ‚Üí SC ‚Üí SP)

O sistema tem `StockTransfer` mas ele √© intra-empresa (entre localiza√ß√µes da mesma empresa), n√£o inter-empresas. Transfer√™ncias entre CNPJs do grupo precisam gerar NF-e e passam por todo o fluxo fiscal. N√£o h√° evid√™ncia de um fluxo de "transfer√™ncia intercompany" estruturado.

### 8.4 Maturidade Fiscal ‚Äî Resumo

| Capacidade | Status | Nota |
|-----------|--------|------|
| NF-e Entrada (captura/manifesta√ß√£o) | ‚úÖ Completo | SEFAZ sync, manifesta√ß√£o, XML |
| NF-e Sa√≠da (emiss√£o) | ‚úÖ Funcional | Fila de emiss√£o, modelo 55 |
| DDA (boletos banc√°rios) | ‚úÖ Funcional | Captura, v√≠nculo AP, aprova√ß√£o |
| SPED Fiscal/Contribui√ß√µes | ‚ö†Ô∏è Parcial | Router existe, sem model de apura√ß√£o |
| Cr√©ditos tribut√°rios (ICMS/IPI/PIS/COFINS) | ‚ö†Ô∏è Parcial | Campos existem, Float nos valores |
| CST por item de NF-e | ‚ùå Ausente | N√£o persistido |
| Cadastro de CFOP | ‚ùå Ausente | Campo solto sem valida√ß√£o |
| Tabela NCM/TIPI | ‚ùå Ausente | NCM √© string sem lookup |
| Regime tribut√°rio por empresa | ‚ùå Ausente | N√£o modelado |
| Apura√ß√£o mensal de impostos | ‚ùå Ausente | Delegado para contabilidade |
| Transfer√™ncia intercompany | ‚ùå Ausente | StockTransfer √© intra-empresa |
| Precis√£o num√©rica (Decimal) na NF-e entrada | ‚ùå Float | Risco de diverg√™ncia SPED |

---

## 9. Matriz de Prioridades Consolidada (Atualizada)

### Prioridade 0 ‚Äî Antes de Qualquer Go-live

| # | A√ß√£o | Perspectiva | Impacto |
|---|------|------------|---------|
| 1 | Migrar Float ‚Üí Decimal em TODOS os models financeiros e fiscais | CFO + Fiscal | Elimina diverg√™ncias em concilia√ß√£o e SPED |
| 2 | Migrar ReceivedInvoice + ReceivedInvoiceItem para Decimal | Fiscal | Cr√©ditos tribut√°rios corretos |
| 3 | companyId obrigat√≥rio em models transacionais | CTO | Seguran√ßa multi-tenant |
| 4 | Campo legacyId para migra√ß√£o Delphi | COO | Habilita rollback |

### Prioridade 1 ‚Äî Go-live M√≥dulo Financeiro + Compras (primeiro)

| # | A√ß√£o | Perspectiva | Impacto |
|---|------|------------|---------|
| 5 | Soft delete em models fiscais/cont√°beis | Fiscal | Compliance, n√£o perder dados fiscais |
| 6 | Auditoria autom√°tica via Prisma middleware | CTO + Fiscal | Rastreabilidade obrigat√≥ria |
| 7 | Regime tribut√°rio por empresa (config) | Fiscal | Base para c√°lculos fiscais corretos |

### Prioridade 2 ‚Äî Go-live Produ√ß√£o

| # | A√ß√£o | Perspectiva | Impacto |
|---|------|------------|---------|
| 8 | FK workCenterId na ProductionOrderOperation | Industrial | Integridade de dados de produ√ß√£o |
| 9 | Roteiro de fabrica√ß√£o (ProductionRouting) | Industrial | Padroniza opera√ß√µes por produto |
| 10 | Rastreabilidade de lote (InventoryLot) | Industrial + Qualidade | Requisito de clientes industriais |

### Prioridade 3 ‚Äî Matura√ß√£o Funcional

| # | A√ß√£o | Perspectiva | Impacto |
|---|------|------------|---------|
| 11 | Cat√°logo de produtos (spec v2.1) | CDO | Diferencial comercial |
| 12 | Cadastro CFOP + CST persistido | Fiscal | Automatiza√ß√£o fiscal |
| 13 | Robustecimento do m√≥dulo de Qualidade (CAPA) | Industrial | Exig√™ncia ISO |
| 14 | CMMS / Manuten√ß√£o industrial | Industrial | Gest√£o de ativos fabris |
| 15 | Transfer√™ncia intercompany (fiscal) | Fiscal + COO | Opera√ß√£o do grupo |
| 16 | Modulariza√ß√£o do mon√≥lito | CTO | Escalabilidade de equipe |

---

## 10. Observa√ß√£o Final ‚Äî Valora√ß√£o para Investidores

Para o material de investidores que est√° sendo preparado: os gaps identificados n√£o diminuem o valor do sistema ‚Äî pelo contr√°rio, eles representam **roadmap de evolu√ß√£o** que um comprador pode acelerar. O que o sistema j√° tem (13 m√≥dulos integrados, comex, fiscal, produ√ß√£o com MES/OEE, workflow engine, multi-tenant para 7 empresas) levaria 3-4 anos e R$ 3-5 milh√µes para construir do zero.

Os gaps industriais (rastreabilidade de lote, CMMS, roteiro) s√£o exatamente o tipo de feature que diferencia um ERP gen√©rico de um ERP de nicho industrial. Implement√°-los transformaria o FRM-ERP de um sistema interno em um produto potencialmente licenci√°vel para o setor metal√∫rgico.

O problema do Float √© t√©cnico e resolve-se com uma migration ‚Äî n√£o √© gap funcional. Mas precisa ser resolvido antes de qualquer apresenta√ß√£o t√©cnica a um investidor que far√° due diligence.
