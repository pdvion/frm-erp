# An√°lise Completa do Sistema FRM-ERP

> Perspectivas: CTO ‚Ä¢ Chief Design Officer ‚Ä¢ COO ‚Ä¢ CFO
> Data: 08/02/2026
> Base: schema.prisma (5.541 linhas), index.ts (routers tRPC), contexto de neg√≥cio FRM

---

## Resumo Executivo

O FRM-ERP √© um sistema monol√≠tico full-stack (Next.js 15 + tRPC + Prisma + Supabase PostgreSQL) que cobre **173 models**, **76 enums** e **81 routers tRPC** ‚Äî abrangendo praticamente toda a opera√ß√£o de um grupo industrial de 7 empresas. √â um sistema ambicioso que vai de compras a folha de pagamento, de com√©rcio exterior a OEE de m√°quinas, com camadas de IA (classificador, embeddings, chart builder) e workflow engine embutidas.

O sistema tem pontos de for√ßa significativos ‚Äî especialmente na arquitetura multi-tenant, na cobertura funcional e na modelagem de dados operacionais ‚Äî mas carrega d√©bitos t√©cnicos importantes que precisam ser endere√ßados antes de um go-live em produ√ß√£o com 7 empresas.

---

## 1. Vis√£o CTO ‚Äî Arquitetura e Qualidade T√©cnica

### 1.1 Escopo e Densidade do Sistema

O sistema tem cobertura funcional equivalente a ERPs de mercado de m√©dio porte. 13 dom√≠nios funcionais completos:

| Dom√≠nio | Models | Routers | Maturidade Estimada |
|---------|--------|---------|---------------------|
| Compras (Suprimentos) | 13 | 5 | Alta |
| Financeiro (CP/CR/Bancos) | 27 | 7 | Alta |
| Estoque/Log√≠stica | 13 | 4 | Alta |
| Produ√ß√£o/PCP | 14 | 4 | M√©dia |
| Fiscal/NF-e/SPED | 10 | 5 | M√©dia |
| RH/DP | 22 | 8 | M√©dia |
| Vendas/CRM | 10 | 4 | M√©dia-Baixa |
| Com√©rcio Exterior | 12 | 1 | M√©dia |
| Qualidade | 5 | 1 | Baixa |
| Cat√°logo/PIM | 6 | 2 | Em desenvolvimento |
| Gest√£o Estrat√©gica (GPD) | 7 | 2 | M√©dia |
| Workflow Engine | 5 | 1 | M√©dia |
| Plataforma (Auth, AI, Notif) | ~30 | ~12 | M√©dia |

**173 models √© muito para um mon√≥lito.** A t√≠tulo de compara√ß√£o, o Odoo (que √© modular) tem ~350 models no core, mas distribu√≠dos em ~30 m√≥dulos independentes. O FRM-ERP tem tudo num √∫nico schema Prisma e um √∫nico router tRPC. Isso funciona na fase de desenvolvimento r√°pido, mas se torna um problema de manuten√ß√£o e deploy conforme a equipe cresce.

### 1.2 Pontos Fortes

**Multi-tenant bem implementado.** O padr√£o `companyId + isShared` est√° presente em 95 models (todos os que precisam). A separa√ß√£o por empresa √© feita por campo, n√£o por schema ‚Äî adequado para o porte de 7 empresas com dados compartilhados (materiais, categorias). 497 indexes sugerem aten√ß√£o com performance de queries.

**Nomenclatura consistente.** Praticamente 100% dos models usam `@@map` para nomes de tabela em snake_case, enquanto os models Prisma seguem PascalCase. Todos usam UUID como PK com `gen_random_uuid()`. O padr√£o `createdAt/updatedAt` est√° presente em todos os models transacionais.

**Fiscal robusto.** Integra√ß√£o SEFAZ completa com sync, manifesta√ß√£o, DDA (boletos banc√°rios), NF-e queue. Inclui SPED. Para uma ind√∫stria brasileira, isso √© miss√£o cr√≠tica e est√° bem modelado.

**Com√©rcio Exterior completo.** ImportProcess com pipeline de custos (FOB ‚Üí CIF ‚Üí DI), contratos de c√¢mbio com varia√ß√£o cambial, incoterms, portos, customs brokers. Isso √© diferencial raro ‚Äî a maioria dos ERPs brasileiros de m√©dio porte n√£o tem m√≥dulo de comex decente.

**Workflow engine embutida.** WorkflowDefinition com steps, transitions, instances, canvas layout (JSON para editor visual), formSchema. Isso d√° flexibilidade para criar fluxos de aprova√ß√£o customizados sem codificar.

### 1.3 D√©bitos T√©cnicos Cr√≠ticos

#### üî¥ Float vs Decimal em Valores Financeiros

**Este √© o problema mais grave do sistema.**

O schema usa `Float` (ponto flutuante IEEE 754) para armazenar valores monet√°rios em AccountsPayable, AccountsReceivable, PayrollItem e dezenas de outros models financeiros. O m√≥dulo de com√©rcio exterior usa `Decimal` corretamente.

```
Float:  333 ocorr√™ncias (inclui valores financeiros)
Decimal: 86 ocorr√™ncias (basicamente s√≥ comex e GPD)
```

O `Float` introduz erros de arredondamento. `0.1 + 0.2 = 0.30000000000000004` em IEEE 754. Para um sistema que soma centenas de parcelas de contas a pagar, calcula IRRF/INSS/FGTS, e faz concilia√ß√£o banc√°ria, isso vai gerar centavos de diferen√ßa que se acumulam e tornam a concilia√ß√£o imposs√≠vel.

**Impacto:** Concilia√ß√£o banc√°ria, fechamento cont√°bil, c√°lculo de impostos retidos, e apura√ß√£o de folha de pagamento podem ter erros silenciosos. Quanto maior o volume de transa√ß√µes, maior a diverg√™ncia acumulada.

**Recomenda√ß√£o:** Migrar todos os campos financeiros para `Decimal(18,2)` ou `Decimal(15,4)`. Isso √© uma migration destrutiva (precisa converter dados existentes) mas n√£o adi√°vel. Prioridade m√°xima.

#### üü° companyId Opcional vs Obrigat√≥rio

66 models t√™m `companyId` como `String?` (nullable) e 29 como `String` (required). Isso cria uma inconsist√™ncia: em models como Material, Supplier, PurchaseOrder, o companyId √© nullable, o que permite registros sem empresa. No contexto multi-tenant, um registro sem `companyId` √© invis√≠vel ou vis√≠vel para todos ‚Äî ambos s√£o problemas. A justifica√ß√£o provavelmente √© o padr√£o `isShared`, mas a maioria dos models transacionais nunca deveria ser "shared" entre empresas.

**Recomenda√ß√£o:** Definir regra: models operacionais/transacionais (pedidos, notas, movimentos) devem ter companyId obrigat√≥rio. Apenas models de configura√ß√£o/cat√°logo podem ter nullable.

#### üü° Aus√™ncia de Soft Delete Uniforme

Apenas 34 ocorr√™ncias de `deletedAt/isActive/isDeleted` num schema de 173 models. A maioria dos models n√£o tem mecanismo de soft delete. Para um ERP ‚Äî onde dados fiscais e cont√°beis nunca devem ser fisicamente exclu√≠dos ‚Äî isso √© uma lacuna de compliance.

#### üü° Models Sat√©lite sem companyId

78 models n√£o t√™m `companyId` ‚Äî s√£o sat√©lites que dependem do pai (ex: `PurchaseOrderItem` herda do `PurchaseOrder`). Isso √© aceit√°vel se todas as queries sempre partem do pai. Mas cria risco se algu√©m fizer uma query direta em `QuoteItem` sem join com `Quote` ‚Äî os dados de m√∫ltiplas empresas se misturam.

### 1.4 Arquitetura e Escalabilidade

**Mon√≥lito acoplado.** 81 routers num √∫nico appRouter. N√£o h√° separa√ß√£o de m√≥dulos, bounded contexts, ou feature flags por m√≥dulo. Deploy de uma corre√ß√£o em folha de pagamento requer deploy de todo o sistema.

**Sem auditoria autom√°tica.** O model `AuditLog` existe, mas a auditoria depende de chamadas expl√≠citas nos routers. N√£o h√° middleware/interceptor Prisma que garanta que toda mutation seja auditada. Para um ERP multi-empresa, auditoria deve ser autom√°tica e irrecus√°vel.

**39 campos JSON schemaless.** JSON √© flex√≠vel mas invis√≠vel para queries SQL e sem valida√ß√£o de schema. O trabalho do catalog-spec (valida√ß√£o Zod por template) √© o caminho correto ‚Äî mas os outros 38 campos JSON do sistema n√£o t√™m valida√ß√£o equivalente.

---

## 2. Vis√£o CDO ‚Äî Design de Produto e UX

### 2.1 Cobertura Funcional como Produto

O FRM-ERP √© mais do que um ERP ‚Äî √© uma plataforma de gest√£o industrial com 5 camadas:

1. **ERP Core:** Compras ‚Üí Estoque ‚Üí Produ√ß√£o ‚Üí Vendas ‚Üí Financeiro ‚Üí Fiscal
2. **RH/DP:** Folha, f√©rias, 13¬∫, benef√≠cios, ponto eletr√¥nico, admiss√£o, portal do colaborador
3. **Industrial:** OEE, MES, custos de produ√ß√£o, MRP, BOM
4. **Intelig√™ncia:** BI (Zoho Analytics integrado), GPD, dashboards, KPIs, embeddings sem√¢nticos
5. **Plataforma:** Workflow engine, notifica√ß√µes, GED (gest√£o eletr√¥nica de documentos), AI classifier, deploy agent

Isso √© uma proposta de valor completa para ind√∫strias de m√©dio porte que hoje pagam TOTVS/Sankhya + HR separado + BI separado.

### 2.2 Fluxos Integrados

O maior diferencial do sistema √© a integra√ß√£o entre m√≥dulos. Exemplos que o schema evidencia:

- **Compra ‚Üí Recebimento ‚Üí Qualidade ‚Üí Estoque ‚Üí Financeiro:** PurchaseOrder ‚Üí MaterialReceiving ‚Üí QualityInspection ‚Üí InventoryMovement ‚Üí AccountsPayable. Chain completa.
- **Venda ‚Üí Picking ‚Üí Faturamento ‚Üí Financeiro:** SalesOrder ‚Üí PickingList ‚Üí IssuedInvoice ‚Üí AccountsReceivable.
- **Importa√ß√£o ‚Üí C√¢mbio ‚Üí Custos ‚Üí Estoque:** ImportProcess ‚Üí ExchangeContract ‚Üí ImportProcessCost ‚Üí InventoryMovement.
- **Requisi√ß√£o ‚Üí Aprova√ß√£o ‚Üí Compra:** MaterialRequisition ‚Üí RequisitionApproval ‚Üí PurchaseOrder (via workflow).

### 2.3 Gaps de Produto

**M√≥dulo de vendas imaturo.** Lead ‚Üí SalesQuote ‚Üí SalesOrder existe, mas falta: pipeline visual, forecast, comiss√µes, territ√≥rios, meta por vendedor. Para uma empresa que exporta para os EUA, o CRM precisa ser mais robusto.

**Qualidade superficial.** QualityInspection e NonConformity existem, mas falta: plano de inspe√ß√£o por material (AQL), rastreabilidade de lote (forward/backward), CAPA (Corrective and Preventive Action), certificados de qualidade vinculados a lotes (o model QualityCertificate existe mas est√° solto). Para uma ind√∫stria que vende rolamentos, rastreabilidade de lote e certificados s√£o requisitos de clientes como montadoras.

**Sem m√≥dulo de manuten√ß√£o (CMMS/PCM).** Uma f√°brica de rolamentos tem tornos CNC, ret√≠ficas, tratamento t√©rmico. N√£o h√° model para cadastro de equipamentos, planos de manuten√ß√£o preventiva, ordens de servi√ßo de manuten√ß√£o. O MachineStop + OeeTarget cobrem monitoramento, mas n√£o gest√£o de manuten√ß√£o.

**GED sem versionamento real.** GedDocument tem `parentId` para vers√µes, mas n√£o tem diff, checkout/lock, ou controle de acesso granular por documento. Para um sistema que gerencia documentos de qualidade ISO, isso √© limitado.

---

## 3. Vis√£o COO ‚Äî Opera√ß√µes e Processo

### 3.1 Cobertura dos Fluxos Operacionais

O sistema cobre o ciclo operacional completo de uma ind√∫stria:

**Supply Chain:** Material ‚Üí Supplier ‚Üí Quote ‚Üí PurchaseOrder ‚Üí MaterialReceiving ‚Üí QualityInspection ‚Üí Inventory ‚Üí StockLocation ‚Üí StockTransfer ‚Üí PickingList

**Produ√ß√£o:** BomItem ‚Üí MrpParameter ‚Üí MrpRun ‚Üí MrpSuggestion ‚Üí ProductionOrder ‚Üí ProductionOrderOperation ‚Üí ProductionLog ‚Üí ProductionCost

**Financeiro:** ReceivedInvoice ‚Üí AccountsPayable ‚Üí PayableApproval ‚Üí PayablePayment ‚Üí BankTransaction ‚Üí Concilia√ß√£o (DDA)

### 3.2 For√ßas Operacionais

**MRP funcional.** MrpParameter (lead times, safety stock, lot sizing) ‚Üí MrpRun ‚Üí MrpSuggestion com tipos (PURCHASE, PRODUCTION, TRANSFER) e status tracking. Isso √© o cora√ß√£o do PCP.

**Picking e WMS b√°sico.** StockLocation com tipo (RECEIVING, STORAGE, SHIPPING, PRODUCTION, QUARANTINE, QUALITY) + LocationInventory + PickingList com verifica√ß√£o. Suporta opera√ß√£o com localiza√ß√£o de estoque.

**Custo de produ√ß√£o detalhado.** ProductionCost com breakdown: materiais (ProductionCostMaterial com custo real vs padr√£o) e m√£o de obra (ProductionCostLabor com horas normais, extras, noturnas). MaterialStandardCost com last/average/standard cost. Isso permite custeio por absor√ß√£o real.

### 3.3 Riscos Operacionais

**Migra√ß√£o Delphi n√£o evidenciada no schema.** Existe um router `delphiImport`, mas o schema n√£o tem campos `legacyId` ou equivalente. Quando migrar dados do sistema legado, ser√° necess√°rio saber qual registro do novo sistema corresponde a qual do antigo. Sem esse mapeamento, rollback √© imposs√≠vel.

**Complexidade do go-live simult√¢neo.** 7 empresas √ó 13 m√≥dulos = 91 combina√ß√µes de go-live. Uma abordagem big-bang √© suicida. A recomenda√ß√£o √© go-live por empresa, come√ßando pela matriz FRM, e por m√≥dulo (financeiro + compras primeiro, produ√ß√£o depois, RH por √∫ltimo).

**Workflow engine como gargalo.** Se todas as aprova√ß√µes (compras, pagamentos, requisi√ß√µes) dependem do workflow engine, a confiabilidade desse m√≥dulo √© cr√≠tica. Um bug no workflow trava toda a opera√ß√£o.

---

## 4. Vis√£o CFO ‚Äî Finan√ßas, Compliance e Risco

### 4.1 Cobertura Financeira

O m√≥dulo financeiro √© robusto em escopo:

- **Contas a Pagar:** 77 campos no AccountsPayable, incluindo reten√ß√µes (IR, ISS, INSS, PIS, COFINS, CSLL), aprova√ß√µes, parcelas, aloca√ß√£o por centro de custo
- **Contas a Receber:** Tracking de juros/multas, regras de cobran√ßa automatizadas (CollectionRule ‚Üí CollectionRuleStep ‚Üí CollectionAction)
- **Bancos:** BankAccount + BankTransaction + PixTransaction + DDA (boletos banc√°rios via arquivo banc√°rio)
- **Or√ßamento:** BudgetAccount ‚Üí BudgetVersion ‚Üí BudgetEntry ‚Üí BudgetActual ‚Üí BudgetAlert. Permite controle or√ßament√°rio com alertas de desvio.

### 4.2 Riscos Financeiros T√©cnicos

#### üî¥ Float nos Valores Financeiros (repetindo pela gravidade)

AccountsPayable.originalValue, .netValue, .paidValue ‚Äî todos `Float`. PayrollItem com baseSalary, grossSalary, netSalary, INSS, IRRF, FGTS ‚Äî todos `Float`. Isso pode gerar diferen√ßas de centavos que, acumuladas em milhares de transa√ß√µes mensais de 7 empresas, produzem diverg√™ncias na concilia√ß√£o banc√°ria e no fechamento cont√°bil.

Cen√°rio real: a soma dos t√≠tulos a pagar de um m√™s pode diferir em R$ 0,37 do saldo banc√°rio. O financeiro perde horas procurando a diferen√ßa. Multiplicado por 7 empresas, s√£o 7 concilia√ß√µes mensais comprometidas.

#### üü° Sem Plano de Contas Cont√°bil

O schema n√£o tem model para plano de contas cont√°bil, lan√ßamentos cont√°beis, raz√£o, balancete. O `BudgetAccount` existe mas √© para or√ßamento, n√£o contabilidade. Isso significa que a contabilidade √© feita fora do sistema (provavelmente no escrit√≥rio cont√°bil), e os dados financeiros do ERP precisam ser exportados para o cont√°bil. Sem integra√ß√£o cont√°bil nativa, o closing mensal depende de processos manuais.

#### üü° Reten√ß√µes Tribut√°rias Simplificadas

AccountsPayable tem campos de reten√ß√£o (IR, ISS, etc.) como Float simples. Faltam: base de c√°lculo, al√≠quota aplicada, c√≥digo de receita (DARF), data de vencimento do imposto retido, e emiss√£o autom√°tica do DARF. Para 7 empresas, o volume de reten√ß√µes √© significativo.

### 4.3 Valora√ß√£o do Sistema

Para efeito de avalia√ß√£o de investidores (documenta√ß√£o que voc√™ est√° preparando):

**Custo de reconstru√ß√£o estimado:** 173 models √ó ~40h m√©dias de desenvolvimento por model (incluindo tRPC, valida√ß√£o, UI, testes) = ~6.920 horas. A R$ 200/h (desenvolvedor s√™nior brasileiro) = **~R$ 1,38 milh√£o** em desenvolvimento puro. Mais ~30% de gest√£o, infra, QA = **~R$ 1,8 milh√£o** de custo de reposi√ß√£o.

**Valor como ativo de software:** O sistema tem valor acima do custo de reposi√ß√£o porque inclui conhecimento de dom√≠nio incorporado (regras de comex, fluxos fiscais brasileiros, l√≥gica de PCP industrial) que levaria anos para reconstruir do zero. Um adquirente que compra o grupo FRM recebe um ERP customizado para o segmento metal√∫rgico que poderia, em tese, ser licenciado para outras ind√∫strias do setor.

---

## 5. Matriz de Prioridades

### A√ß√µes Imediatas (antes de qualquer go-live)

| # | A√ß√£o | Impacto | Esfor√ßo |
|---|------|---------|---------|
| 1 | Migrar Float ‚Üí Decimal em todos os models financeiros | Elimina erros de arredondamento | Alto (migration destrutiva) |
| 2 | Tornar companyId obrigat√≥rio em models transacionais | Previne vazamento de dados entre empresas | M√©dio |
| 3 | Implementar auditoria autom√°tica via Prisma middleware | Compliance e rastreabilidade | M√©dio |
| 4 | Adicionar campo legacyId para migra√ß√£o Delphi | Habilita rollback e reconcilia√ß√£o | Baixo |

### Curto Prazo (3 meses)

| # | A√ß√£o | Impacto | Esfor√ßo |
|---|------|---------|---------|
| 5 | Implementar soft delete em models fiscais/cont√°beis | Compliance fiscal | M√©dio |
| 6 | Cat√°logo de produtos (spec v2.1 ‚Äî em andamento) | Diferencial comercial | Alto |
| 7 | Robustecer m√≥dulo de qualidade (rastreabilidade, CAPA) | Requisito de clientes industriais | Alto |
| 8 | Valida√ß√£o JSON schemas para todos os campos Json | Integridade de dados | M√©dio |

### M√©dio Prazo (6-12 meses)

| # | A√ß√£o | Impacto | Esfor√ßo |
|---|------|---------|---------|
| 9 | Modulariza√ß√£o do mon√≥lito (bounded contexts) | Manuten√ß√£o e deploy independente | Muito Alto |
| 10 | Plano de contas e integra√ß√£o cont√°bil | Elimina export manual para cont√°bil | Alto |
| 11 | CRM/Vendas completo (pipeline, forecast, comiss√µes) | Habilita crescimento comercial | Alto |
| 12 | CMMS/Manuten√ß√£o industrial | Gest√£o de ativos fabris | Alto |

---

## 6. N√∫meros do Sistema (Refer√™ncia R√°pida)

| M√©trica | Valor |
|---------|-------|
| Models Prisma | 173 |
| Enums | 76 |
| Routers tRPC | 81 |
| Indexes (@@index) | 497 |
| Unique constraints (@@unique) | 55 |
| Campos Float (inclui financeiros) | 333 |
| Campos Decimal (corretos) | 86 |
| Campos JSON (schemaless) | 39 |
| Models com companyId | 95 |
| Models sem companyId (sat√©lites) | 78 |
| Backrelations no model Company | 74 |
| Backrelations no model Material | 25 |
| Linhas do schema | 5.541 |
